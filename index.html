<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 4Âπ¥ÁîüÂ∞èÊï∞Áâà</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1) rotate(0deg);color:#333}20%{transform:scale(1.5) rotate(90deg);color:#ff0;filter:drop-shadow(0 0 20px #ff0)}40%{transform:scale(2) rotate(180deg);color:#f0f;filter:drop-shadow(0 0 30px #f0f)}60%{transform:scale(2.5) rotate(270deg);color:#0ff;filter:drop-shadow(0 0 40px #0ff)}80%{transform:scale(3) rotate(360deg);color:#0f0;filter:drop-shadow(0 0 50px #0f0)}100%{transform:scale(1) rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}}
@keyframes correct{0%{transform:scale(1);color:#333}25%{transform:scale(1.3) rotate(10deg);color:#0f0;filter:drop-shadow(0 0 15px #0f0)}50%{transform:scale(1.5) rotate(-10deg);color:#00ff00;filter:drop-shadow(0 0 25px #00ff00)}75%{transform:scale(1.3) rotate(5deg);color:#32cd32;filter:drop-shadow(0 0 20px #32cd32)}100%{transform:scale(1);color:gold;filter:drop-shadow(0 0 10px gold)}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
.mode-btn.hidden{background:#ff6b6b;animation:hiddenPulse 2s infinite}
.mode-btn.hidden:hover{background:#d32f2f}
@keyframes hiddenPulse{0%,100%{transform:scale(1);box-shadow:0 0 10px #ff6b6b}50%{transform:scale(1.05);box-shadow:0 0 20px #ff6b6b}}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.progress-bar.hidden{background:linear-gradient(45deg,#ff6b6b,#ffd700,#4caf50,#2196f3);background-size:400% 400%;animation:hiddenProgress 3s ease infinite}
@keyframes hiddenProgress{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.mode-info.hidden{background:linear-gradient(45deg,#ffebee,#fff3e0,#e8f5e8,#e3f2fd);color:#d32f2f;border:2px solid #ff6b6b;animation:hiddenGlow 2s infinite}
@keyframes hiddenGlow{0%,100%{box-shadow:0 0 10px rgba(255,107,107,0.3)}50%{box-shadow:0 0 20px rgba(255,107,107,0.6)}}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
@keyframes rainbow{0%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}25%{background:linear-gradient(45deg,#a8e6cf,#dcedc1);transform:scale(1.05)}50%{background:linear-gradient(45deg,#ffd93d,#ff6b6b);transform:scale(1.1)}75%{background:linear-gradient(45deg,#74b9ff,#0984e3);transform:scale(1.05)}100%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:180px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.normal-input input{width:100px;text-align:center}
.unit-display{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.choice-buttons{display:flex;justify-content:center;gap:20px;margin:20px 0}
.choice-btn{padding:15px 30px;font-size:20px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;min-width:120px}
.choice-btn:hover{background:#1976d2}
.choice-btn.selected{background:#ff9800;transform:scale(1.05)}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.level-select{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;max-width:600px;margin:20px auto}
.level-btn{padding:15px;background:#e3f2fd;border:2px solid #2196f3;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:all 0.3s}
.level-btn:hover{background:#2196f3;color:white;transform:scale(1.05)}
.level-btn h4{margin:5px 0;font-size:16px}
.level-btn p{margin:5px 0;font-size:12px;opacity:0.8}
.correct-celebration{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;background:radial-gradient(circle,#ff0,#f00);border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{0%{transform:scale(1);opacity:1}100%{transform:scale(20);opacity:0}}
.nav-buttons{display:flex;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.nav-btn{background:#6c757d;color:white;padding:8px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
.nav-btn:hover{background:#5a6268}
.timer{font-size:20px;font-weight:bold;color:#d32f2f;margin:10px 0;padding:10px;background:white;border-radius:8px;border:2px solid #f44336}
.points-display{background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:15px;border-radius:10px;margin:15px 0;border:3px solid #ff6b6b;font-weight:bold;font-size:18px;animation:pointsGlow 2s infinite}
@keyframes pointsGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5)}50%{box-shadow:0 0 30px rgba(255,215,0,0.8)}}
.points-earned{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50;font-weight:bold;animation:pointsEarn 2s}
@keyframes pointsEarn{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.session-points{background:#e3f2fd;color:#1976d2;padding:8px;border-radius:6px;margin:5px 0;border:1px solid #2196f3;font-size:14px}
.player-id{background:#f3e5f5;color:#7b1fa2;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #9c27b0;font-size:14px;font-weight:bold}
.position-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0}
.position-inputs span{font-size:18px;margin:0 5px}
.position-inputs input{width:80px;font-size:18px}
.multi-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0;flex-wrap:wrap}
.multi-inputs span{font-size:18px;margin:0 5px}
.multi-inputs input{width:80px;font-size:18px}
.hidden-stage-unlock{background:linear-gradient(45deg,#ff6b6b,#ffd700);color:white;font-weight:bold;animation:hiddenUnlock 3s infinite}
@keyframes hiddenUnlock{0%,100%{transform:scale(1);box-shadow:0 0 15px rgba(255,107,107,0.5)}50%{transform:scale(1.1);box-shadow:0 0 30px rgba(255,215,0,0.8)}}
@keyframes titleGlow{0%,100%{transform:scale(1);box-shadow:0 0 20px #ffd700}50%{transform:scale(1.05);box-shadow:0 0 40px #ffd700,0 0 60px #ff6b6b}}
@keyframes masterCelebration{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.5) rotate(90deg);filter:hue-rotate(90deg)}50%{transform:scale(2) rotate(180deg);filter:hue-rotate(180deg)}75%{transform:scale(1.5) rotate(270deg);filter:hue-rotate(270deg)}100%{transform:scale(1) rotate(360deg);filter:hue-rotate(360deg)}}
.master-celebration{animation:masterCelebration 4s ease-in-out}
</style>
</head>
<body>
<h1>üßÆ ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 4Âπ¥ÁîüÂ∞èÊï∞Áâà</h1>

<div id="start">
<h2>„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div id="playerIdDisplay" class="player-id" style="display:none">üë§ „Éó„É¨„Ç§„É§„ÉºID: <span id="playerId"></span></div>
<div id="pointsDisplay" class="points-display" style="display:none">üí∞ Á∑è„Éù„Ç§„É≥„Éà: <span id="totalPoints">0</span>P</div>
<div class="info">
<div class="mode-info select"><h3>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</h3><p>‚Ä¢ Â•Ω„Åç„Å™„É¨„Éô„É´„ÇíÈÅ∏„Çì„ÅßÁ∑¥Áøí<br>‚Ä¢ ‰ΩïÂ∫¶„Åß„ÇÇÊåëÊà¶ÂèØËÉΩ<br>‚Ä¢ Ê≠£Ëß£„Åß„Éù„Ç§„É≥„ÉàÁç≤Âæó</p></div>
<div class="mode-info practice"><h3>üìö Á∑¥Áøí„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂêÑ„É¨„Éô„É´„Åß5ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊ¨°„ÅÆ„É¨„Éô„É´„Å∏<br>‚Ä¢ ÈñìÈÅï„Åà„Åü„Çâ„Åù„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çã<br>‚Ä¢ „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åß„Éú„Éº„Éä„Çπ„Éù„Ç§„É≥„Éà<br>‚Ä¢ <strong>ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ„ÅÆ3ÂÄç„ÅÆ„Éù„Ç§„É≥„ÉàÁç≤ÂæóÔºÅ</strong></p></div>
<div class="mode-info summary"><h3>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂÖ®11„É¨„Éô„É´√óÂêÑ5ÂïèÔºùË®à55Âïè„Å´ÊåëÊà¶<br>‚Ä¢ ‰∏ÄÂïè„Åß„ÇÇÈñìÈÅï„Åà„Çã„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº<br>‚Ä¢ „ÇØ„É™„Ç¢ÊôÇÈñì„Å´Âøú„Åò„Å¶Â§ßÈáè„Éù„Ç§„É≥„ÉàÁç≤Âæó<br>‚Ä¢ <strong>„ÇØ„É™„Ç¢„ÅßÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏Ëß£ÊîæÔºÅ</strong></p></div>
<div id="hiddenModeInfo" class="mode-info hidden" style="display:none"><h3>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</h3><p>‚Ä¢ Ë∂ÖÈ´òÈõ£Â∫¶„ÅÆÂ∞èÊï∞ÂïèÈ°å„Å´ÊåëÊà¶<br>‚Ä¢ ÂÖ®10Âïè„ÇØ„É™„Ç¢„Åß„ÄåÂ∞èÊï∞„Éû„Çπ„Çø„Éº„Äç„ÅÆÁß∞Âè∑Áç≤Âæó<br>‚Ä¢ Ê¥æÊâã„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÁ•ùÁ¶èÔºÅ</p></div>
</div>
<button class="mode-btn select" onclick="showLevelSelect()">üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</button>
<button class="mode-btn practice" onclick="selectMode('practice')">üìö Á∑¥Áøí„É¢„Éº„Éâ</button>
<button class="mode-btn" onclick="selectMode('summary')">üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</button>
<button id="hiddenStageBtn" class="mode-btn hidden" onclick="selectMode('hidden')" style="display:none">üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</button>
</div>

<div id="levelSelect" style="display:none">
<h2>üéÆ „É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div class="level-select">
<div class="level-btn" onclick="selectLevel(1)"><h4>üîÑ „É¨„Éô„É´1</h4><p>„Åü„Çì„ÅÑ„Å∏„Çì„Åã„Çì</p></div>
<div class="level-btn" onclick="selectLevel(2)"><h4>üî¢ „É¨„Éô„É´2</h4><p>Â∞èÊï∞„ÅÆ‰ªïÁµÑ„Åø</p></div>
<div class="level-btn" onclick="selectLevel(3)"><h4>üìç „É¨„Éô„É´3</h4><p>Â∞èÊï∞„ÅÆ‰Ωç</p></div>
<div class="level-btn" onclick="selectLevel(4)"><h4>‚öñÔ∏è „É¨„Éô„É´4</h4><p>Â∞èÊï∞„ÅÆÂ§ßÂ∞è</p></div>
<div class="level-btn" onclick="selectLevel(5)"><h4>‚úñÔ∏è „É¨„Éô„É´5</h4><p>Â∞èÊï∞ ‰ΩïÂÄç„Åã</p></div>
<div class="level-btn" onclick="selectLevel(6)"><h4>‚ûó „É¨„Éô„É´6</h4><p>Â∞èÊï∞ ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åã</p></div>
<div class="level-btn" onclick="selectLevel(7)"><h4>üî≤ „É¨„Éô„É´7</h4><p>Â∞èÊï∞„ÅÆ„Åì„ÅÜ„Åõ„ÅÑ</p></div>
<div class="level-btn" onclick="selectLevel(8)"><h4>‚ûï „É¨„Éô„É´8</h4><p>Â∞èÊï∞„ÅÆË∂≥„ÅóÁÆó</p></div>
<div class="level-btn" onclick="selectLevel(9)"><h4>‚ûñ „É¨„Éô„É´9</h4><p>Â∞èÊï∞„ÅÆ„Å≤„ÅçÁÆó</p></div>
<div class="level-btn" onclick="selectLevel(10)"><h4>üìù „É¨„Éô„É´10</h4><p>Â∞èÊï∞ÊñáÁ´†ÂïèÈ°å</p></div>
<div class="level-btn" onclick="selectLevel(11)"><h4>üëë „É¨„Éô„É´11</h4><p>Â∞èÊï∞„ÅÆËâ≤„ÄÖ„Å™Ë¶ãÊñπ</p></div>
</div>
<button onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>„É¨„Éô„É´<span id="lv">1</span>/11 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
<div id="sessionPoints" class="session-points" style="display:none">‰ªäÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥: <span id="sessionPointsValue">0</span>P</div>
</div>

<div id="timerDisplay" class="timer" style="display:none">‚è±Ô∏è ÁµåÈÅéÊôÇÈñì: <span id="timer">00:00</span></div>

<div class="nav-buttons">
<button class="nav-btn" onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
<button class="nav-btn" id="levelSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã</button>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">üéØ</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>Á≠î„Åà„ÇíÂÖ•Âäõ</h3>
<div class="normal-input">
<input type="text" id="norm" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
<div id="nUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">Á≠î„Åà„Çã</button>
</div>
</div>

<div id="positionInputs" class="position-inputs" style="display:none">
<span>1„ÅÆ‰Ωç:</span><input type="number" id="ones" min="0" max="9">
<span>0.1„ÅÆ‰Ωç:</span><input type="number" id="tenths" min="0" max="9">
<span>0.01„ÅÆ‰Ωç:</span><input type="number" id="hundredths" min="0" max="9">
<span>0.001„ÅÆ‰Ωç:</span><input type="number" id="thousandths" min="0" max="9">
<button class="submit-btn" onclick="submitPosition()">Á≠î„Åà„Çã</button>
</div>

<div id="multiInputs" class="multi-inputs" style="display:none">
<span id="multiLabel1">1„Çí</span><input type="number" id="multi1" min="0" max="99"><span id="multiUnit1">„Åì</span>
<span id="multiLabel2">0.1„Çí</span><input type="number" id="multi2" min="0" max="99"><span id="multiUnit2">„Åì</span>
<span id="multiLabel3">0.01„Çí</span><input type="number" id="multi3" min="0" max="99"><span id="multiUnit3">„Åì</span>
<button class="submit-btn" onclick="submitMulti()">Á≠î„Åà„Çã</button>
</div>

<div id="choiceButtons" class="choice-buttons" style="display:none">
<button class="choice-btn" onclick="selectChoice('left')">Â∑¶</button>
<button class="choice-btn" onclick="selectChoice('right')">Âè≥</button>
</div>

<div id="wrong" style="display:none">
<div id="wrongMsg" class="error-msg">„Åæ„Å°„Åå„ÅÑ„Åß„Åô„ÄÇ</div>
<div id="correctAnswer" class="correct-answer" style="display:none"><strong>Ê≠£Ëß£Ôºö</strong><span id="correctText"></span></div>
<div id="practiceMsg" style="display:none"><p>„Åì„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇÈ†ëÂºµ„Å£„Å¶ÔºÅ</p></div>
<div id="selectMsg" style="display:none"><p>„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p></div>
<button onclick="retry()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
<button onclick="next()">„Å§„Åé„Å∏</button>
<button id="backToSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>
</div>

<div class="status">
<span>„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 55Âïè‰∏≠</span>
<span id="hiddenQ" style="display:none"> / 10Âïè‰∏≠</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
<div class="monster" style="font-size:120px">üòµ</div>
<h2>ÊÆãÂøµÔºÅ</h2>
<div class="info">
<p>Âà∞ÈÅî„É¨„Éô„É´: <span id="finalLv"></span>/11</p>
<p>Ê≠£Ëß£Êï∞: <span id="finalScore1"></span>Âïè</p>
<p id="finalTime" style="display:none">ÁµåÈÅéÊôÇÈñì: <span id="finalTimeValue"></span></p>
<div id="gameoverPoints" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="gameoverPointsValue">0</span>P</div>
<div id="currentPointsGameover" class="points-display">üí∞ ÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà: <span id="currentPointsGameoverValue">0</span>P</div>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ üéâ</h1>
<div class="monster" style="font-size:120px">üëë</div>
<h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅÂÖ®„É¨„Éô„É´Âà∂Ë¶áÔºÅ</h2>
<div class="info">
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore2"></span>ÂïèÊ≠£Ëß£</p>
<p id="clearTime">„ÇØ„É™„Ç¢ÊôÇÈñì: <span id="clearTimeValue"></span></p>
<div id="pointsEarned" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="earnedPoints">0</span>P</div>
<div id="currentPointsClear" class="points-display">üí∞ ÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà: <span id="currentPointsClearValue">0</span>P</div>
</div>
<div id="hiddenStageUnlock" class="hidden-stage-unlock" style="display:none;padding:20px;margin:20px;border-radius:15px;">
<h3>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅåËß£Êîæ„Åï„Çå„Åæ„Åó„ÅüÔºÅ üåü</h3>
<p>‰ªä„Åô„ÅêÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏„Å´ÊåëÊà¶„Åß„Åç„Åæ„ÅôÔºÅ</p>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="hiddenClear" style="display:none">
<div style="background:linear-gradient(45deg,#ff9a9e,#fecfef,#a8e6cf,#dcedc1);padding:40px;border-radius:20px;animation:rainbow 3s infinite;">
<h1>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ üåü</h1>
<div class="monster master-celebration" style="font-size:150px;">üëë</div>
<h2>üèÜ Â∞èÊï∞„Éû„Çπ„Çø„ÉºË™ïÁîüÔºÅ üèÜ</h2>
<p style="font-size:20px;color:#d32f2f;font-weight:bold;">„ÅÇ„Å™„Åü„ÅØÁúü„ÅÆÂ∞èÊï∞„ÅÆÈÅî‰∫∫„Åß„ÅôÔºÅ</p>
<div style="margin:20px 0;font-size:18px;">
<p>Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏ÂÖ®10ÂïèÂÆåÂÖ®Âà∂Ë¶á</p>
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="hiddenFinalScore"></span>ÂïèÊ≠£Ëß£</p>
<div id="hiddenPointsEarned" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="hiddenEarnedPoints">0</span>P</div>
<div id="currentPointsHidden" class="points-display">üí∞ ÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà: <span id="currentPointsHiddenValue">0</span>P</div>
</div>
<button onclick="restart()" style="padding:15px 30px;font-size:20px;background:#4CAF50;color:white;border:none;border-radius:10px;cursor:pointer;">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
</div>
</div>

<div id="celebration" class="correct-celebration"></div>

<script>
const $=id=>document.getElementById(id)||{style:{},textContent:'',innerHTML:'',value:'',classList:{add:()=>{},remove:()=>{}},appendChild:()=>{},remove:()=>{},focus:()=>{}};
let state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0};
const monsters=["üéØ","üåü","üíé","üé®","üé™","üé≠","üéµ","üé∏","üé≤","üëë","üåà"];
const lvNames=["„Åü„Çì„ÅÑ„Å∏„Çì„Åã„Çì","Â∞èÊï∞„ÅÆ‰ªïÁµÑ„Åø","Â∞èÊï∞„ÅÆ‰Ωç","Â∞èÊï∞„ÅÆÂ§ßÂ∞è","Â∞èÊï∞ ‰ΩïÂÄç„Åã","Â∞èÊï∞ ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åã","Â∞èÊï∞„ÅÆ„Åì„ÅÜ„Åõ„ÅÑ","Â∞èÊï∞„ÅÆË∂≥„ÅóÁÆó","Â∞èÊï∞„ÅÆ„Å≤„ÅçÁÆó","Â∞èÊï∞ÊñáÁ´†ÂïèÈ°å","Â∞èÊï∞„ÅÆËâ≤„ÄÖ„Å™Ë¶ãÊñπ"];
let totalPoints=0,hiddenStageAvailable=false,playerId='';

// „Éó„É¨„Ç§„É§„ÉºID„ÅÆÁîüÊàê„Å®ÁÆ°ÁêÜ
function generatePlayerId(){
    const now=new Date();
    const year=now.getFullYear();
    const month=(now.getMonth()+1).toString().padStart(2,'0');
    const day=now.getDate().toString().padStart(2,'0');
    const hour=now.getHours().toString().padStart(2,'0');
    const minute=now.getMinutes().toString().padStart(2,'0');
    const second=now.getSeconds().toString().padStart(2,'0');
    return`${year}${month}${day}${hour}${minute}${second}`;
}

function initializePlayerId(){
    try{
        playerId=localStorage.getItem('playerId');
        if(!playerId){
            playerId=generatePlayerId();
            localStorage.setItem('playerId',playerId);
        }
    }catch(e){
        playerId=generatePlayerId();
    }
}

// Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅÆÂé≥Ê†º„Å™Âà∂Âæ°
function enableHiddenStage(){hiddenStageAvailable=true;$("hiddenStageBtn").style.display="inline-block";$("hiddenModeInfo").style.display="block"}
function disableHiddenStage(){hiddenStageAvailable=false;$("hiddenStageBtn").style.display="none";$("hiddenModeInfo").style.display="none"}

try{totalPoints=parseInt(localStorage.getItem('totalPoints')||'0')}catch(e){}
const titles={decimalMaster:{name:"Â∞èÊï∞„Éû„Çπ„Çø„Éº",description:"Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇíÂà∂Ë¶á„Åó„ÅüÁúü„ÅÆÂ∞èÊï∞„ÅÆÈÅî‰∫∫",unlocked:false}};

window.addEventListener('load',()=>{
    initializePlayerId();
    $("playerIdDisplay").style.display="block";
    $("playerId").textContent=playerId;
    if(totalPoints>0){
        $("pointsDisplay").style.display="block";
        $("totalPoints").textContent=totalPoints;
    }
});

const R=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
function formatTime(s){const m=Math.floor(s/60);return`${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`}

function calculateClearPoints(clearTime){
    // „Åæ„Å®„ÇÅ„É¢„Éº„Éâ„ÇØ„É™„Ç¢ÊôÇ„ÅÆ„Éù„Ç§„É≥„Éà„Çí10ÂÄç„Å´Â§âÊõ¥
    if(clearTime<=300)return 20000;
    else if(clearTime<=600)return 15000;
    else if(clearTime<=900)return 12000;
    else if(clearTime<=1200)return 10000;
    else if(clearTime<=1800)return 8000;
    else return 5000;
}

// ÂæóÁÇπË®àÁÆóÈñ¢Êï∞„Çí‰øÆÊ≠£ÔºöÁ∑¥Áøí„É¢„Éº„Éâ„ÅØÈÅ∏„Åπ„Çã„É¢„Éº„Éâ„ÅÆ3ÂÄç
function calculateLevelPoints(level){
    if(state.mode === 'summary') return level*50;
    else if(state.mode === 'practice') return Math.floor(level*15); // ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ„ÅÆ3ÂÄçÔºà5*3=15Ôºâ
    else return Math.floor(level*5); // ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ
}

function calculateCorrectPoints(level){
    if(state.mode === 'summary') return Math.min(level*10,100);
    else if(state.mode === 'practice') return Math.floor(Math.min(level*3,30)); // ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ„ÅÆ3ÂÄçÔºà1*3=3Ôºâ
    else return Math.floor(Math.min(level*1,10)); // ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ
}

function addPoints(points,showAnimation=true){totalPoints+=points;state.sessionPoints+=points;try{localStorage.setItem('totalPoints',totalPoints.toString())}catch(e){}$("totalPoints").textContent=totalPoints;$("sessionPointsValue").textContent=state.sessionPoints;$("pointsDisplay").style.display="block";$("sessionPoints").style.display="block";if(showAnimation)showPointsAnimation(points)}
function showPointsAnimation(points){const pointsDiv=document.createElement('div');pointsDiv.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:20px;border-radius:15px;font-size:24px;font-weight:bold;z-index:3000;animation:pointsEarn 2s;border:3px solid #ff6b6b;">+${points}P Áç≤ÂæóÔºÅ</div>`;document.body.appendChild(pointsDiv);setTimeout(()=>pointsDiv.remove(),2000)}

function startTimer(){if(state.mode==='summary'||state.mode==='hidden'){state.startTime=Date.now();$("timerDisplay").style.display="block";state.timerInterval=setInterval(updateTimer,1000)}}
function updateTimer(){if(state.startTime){const elapsed=Math.floor((Date.now()-state.startTime)/1000);$("timer").textContent=formatTime(elapsed)}}
function stopTimer(){if(state.timerInterval){clearInterval(state.timerInterval);state.timerInterval=null}}
function getElapsedTime(){return state.startTime?Math.floor((Date.now()-state.startTime)/1000):0}

function createFireworks(){const celebration=$("celebration");celebration.innerHTML="";for(let i=0;i<15;i++){setTimeout(()=>{const firework=document.createElement("div");firework.className="firework";firework.style.left=Math.random()*window.innerWidth+"px";firework.style.top=Math.random()*window.innerHeight+"px";firework.style.background=`radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${Math.random()*360}, 100%, 70%))`;celebration.appendChild(firework);setTimeout(()=>firework.remove(),2000)},i*100)}for(let i=0;i<30;i++){setTimeout(()=>{const sparkle=document.createElement("div");sparkle.className="sparkle";sparkle.style.left=Math.random()*window.innerWidth+"px";sparkle.style.top=Math.random()*window.innerHeight+"px";celebration.appendChild(sparkle);setTimeout(()=>sparkle.remove(),1500)},i*50)}}

function createMasterFireworks(){const celebration=$("celebration");celebration.innerHTML="";for(let i=0;i<50;i++){setTimeout(()=>{const firework=document.createElement("div");firework.className="firework";firework.style.left=Math.random()*window.innerWidth+"px";firework.style.top=Math.random()*window.innerHeight+"px";firework.style.background=`radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${(Math.random()*360+180)%360}, 100%, 70%))`;firework.style.animation=`firework ${2+Math.random()}s ease-out forwards`;celebration.appendChild(firework);setTimeout(()=>firework.remove(),3000)},i*50)}for(let i=0;i<100;i++){setTimeout(()=>{const star=document.createElement("div");star.innerHTML="‚≠ê";star.style.position="absolute";star.style.left=Math.random()*window.innerWidth+"px";star.style.top=Math.random()*window.innerHeight+"px";star.style.fontSize=(10+Math.random()*20)+"px";star.style.animation=`sparkle ${1+Math.random()}s ease-out infinite`;star.style.pointerEvents="none";celebration.appendChild(star);setTimeout(()=>star.remove(),3000)},i*30)}}

function unlockTitle(titleKey){if(titles[titleKey]){titles[titleKey].unlocked=true;try{localStorage.setItem(`title_${titleKey}`,'true')}catch(e){}showTitleUnlock(titles[titleKey])}}

function showTitleUnlock(title){const titleDiv=document.createElement('div');titleDiv.innerHTML=`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center"><div style="background:linear-gradient(45deg,#ffd700,#ffed4e);padding:40px;border-radius:20px;text-align:center;border:5px solid #ff6b6b;animation:titleGlow 2s infinite"><h1 style="color:#d32f2f;font-size:36px;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.5)">üèÜ Áß∞Âè∑Áç≤ÂæóÔºÅ üèÜ</h1><div style="font-size:48px;margin:20px 0">üëë</div><h2 style="color:#1976d2;font-size:28px;margin:10px 0">${title.name}</h2><p style="color:#333;font-size:16px;margin:0">${title.description}</p><button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px;padding:12px 24px;font-size:18px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer">Á¢∫Ë™ç</button></div></div>`;document.body.appendChild(titleDiv)}

// Â∞èÊï∞ÂïèÈ°åÁîüÊàêÈñ¢Êï∞
function generateProblem(level){
    if(state.mode==='hidden'){
        // Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏Áî®„ÅÆË∂ÖÈ´òÈõ£Â∫¶ÂïèÈ°å
        const patterns=[
            ()=>{
                const kg=R(5,15);
                const g=R(100,999);
                const mg=R(10,999);
                return{
                    q:`${kg}kg${g}g${mg}mg„Çí kg„Åß „ÅÇ„Çâ„Çè„Åó„Åæ„Åó„Çá„ÅÜ`,
                    a:(kg+g/1000+mg/1000000).toFixed(6).replace(/\.?0+$/,''),
                    unit:"kg",
                    type:'normal'
                };
            },
            ()=>{
                const base=R(100,999)/1000;
                const mult=R(1000,10000);
                return{
                    q:`${base.toFixed(3)}„Çí‰ΩïÂÄç„Åô„Çã„Å®${(base*mult).toFixed(0)}„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,
                    a:mult.toString(),
                    type:'normal'
                };
            },
            ()=>{
                const a1=R(100,999)/100;
                const a2=R(100,999)/100;
                const a3=R(100,999)/100;
                return{
                    q:`${a1.toFixed(2)} + ${a2.toFixed(2)} - ${a3.toFixed(2)} =`,
                    a:(a1+a2-a3).toFixed(3).replace(/\.?0+$/,''),
                    type:'normal'
                };
            }
        ];
        return patterns[R(0,2)]();
    }

    switch(level){
        case 1: // Âçò‰ΩçÂ§âÊèõ
            const kg=R(1,9);
            const g=R(1,999);
            return {
                q:`${kg}kg${g}g„Çí kg„Åß „ÅÇ„Çâ„Çè„Åó„Åæ„Åó„Çá„ÅÜ`,
                a:(kg+g/1000).toFixed(3).replace(/\.?0+$/,''),
                unit:"kg",
                type:'normal'
            };

        case 2: // Â∞èÊï∞„ÅÆ‰ªïÁµÑ„Åø
            const problems2=[
                ()=>({q:"0.1„ÅØ1„ÅÆ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åß„Åô„ÅãÔºü",a:"10",unit:"ÂàÜ„ÅÆ‰∏Ä",type:'normal'}),
                ()=>({q:"0.01„ÅØ1„ÅÆ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åß„Åô„ÅãÔºü",a:"100",unit:"ÂàÜ„ÅÆ‰∏Ä",type:'normal'}),
                ()=>({q:"0.001„ÅØ1„ÅÆ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åß„Åô„ÅãÔºü",a:"1000",unit:"ÂàÜ„ÅÆ‰∏Ä",type:'normal'}),
                ()=>({q:"0.1„ÅØ‰ΩïÂÄç„Åô„Çã„Å®1„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü",a:"10",unit:"ÂÄç",type:'normal'}),
                ()=>({q:"0.01„ÅØ‰ΩïÂÄç„Åô„Çã„Å®1„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü",a:"100",unit:"ÂÄç",type:'normal'}),
                ()=>({q:"0.001„ÅØ‰ΩïÂÄç„Åô„Çã„Å®1„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü",a:"1000",unit:"ÂÄç",type:'normal'})
            ];
            return problems2[R(0,problems2.length-1)]();

        case 3: // Â∞èÊï∞„ÅÆ‰Ωç
            const ones=R(1,9);
            const tenths=R(0,9);
            const hundredths=R(0,9);
            const thousandths=R(0,9);
            return {
                q:`${ones}.${tenths}${hundredths}${thousandths}„ÅØ1„Çí‰ΩïÂÄã„ÄÅ0.1„Çí‰ΩïÂÄã„ÄÅ0.01„Çí‰ΩïÂÄã„ÄÅ0.001„Çí‰ΩïÂÄãÈõÜ„ÇÅ„ÅüÊï∞„Åß„Åó„Çá„ÅÜÔºü`,
                a:`${ones},${tenths},${hundredths},${thousandths}`,
                type:'position'
            };

        case 4: // Â∞èÊï∞„ÅÆÂ§ßÂ∞èÔºàÂè≥„ÅãÂ∑¶„ÇíÈÅ∏„Å∂„Éú„Çø„É≥„ÅÆ„ÅøÔºâ
            const patterns=[
                ()=>{
                    const base=R(1,20);
                    const decimal1=R(100,999);
                    const decimal2=R(10,99);
                    const a1=parseFloat(`${base}.${decimal1}`);
                    const a2=parseFloat(`${base}.${decimal2}`);
                    return {a1,a2};
                },
                ()=>{
                    const base=R(10,25);
                    const decimal1=R(100,199);
                    const decimal2=R(1,9);
                    const a1=parseFloat(`${base}.${decimal1}`);
                    const a2=parseFloat(`${base}.0${decimal2}`);
                    return {a1,a2};
                }
            ];

            const pattern=patterns[R(0,patterns.length-1)]();
            let {a1,a2}=pattern;

            while(a1===a2){
                const newPattern=patterns[R(0,patterns.length-1)]();
                a1=newPattern.a1;
                a2=newPattern.a2;
            }

            const question=R(0,1)?"Â∞è„Åï„ÅÑ„Åª„ÅÜ":"Â§ß„Åç„ÅÑ„Åª„ÅÜ";
            const isLeftSmaller=a1<a2;
            let correctSide;
            if(question==="Â∞è„Åï„ÅÑ„Åª„ÅÜ"){
                correctSide=isLeftSmaller?"left":"right";
            }else{
                correctSide=isLeftSmaller?"right":"left";
            }

            return {
                q:`${a1}„Å®${a2}„Åß${question}„ÇíÈÅ∏„Å≥„Åæ„Åó„Çá„ÅÜ`,
                a:correctSide,
                type:'choice'
            };

        case 5: // Â∞èÊï∞ ‰ΩïÂÄç„Åã
            const multipliers = [10, 100, 1000];
            const multiplier = multipliers[R(0, multipliers.length-1)];
            let base5;
            if(multiplier === 10) {
                base5 = R(1, 99) / 100;
            } else if(multiplier === 100) {
                base5 = R(1, 99) / 1000;
            } else {
                base5 = R(1, 99) / 10000;
            }
            const result = base5 * multiplier;
            return {
                q: `${base5.toFixed(4).replace(/\.?0+$/, '')}„Çí‰ΩïÂÄç„Åô„Çã„Å®${result.toFixed(3).replace(/\.?0+$/, '')}„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,
                a: multiplier.toString(),
                type:'normal'
            };

        case 6: // Â∞èÊï∞ ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åã
            const divisors = [10, 100, 1000];
            const divisor = divisors[R(0, divisors.length-1)];
            let base6;
            if(divisor === 10) {
                base6 = R(10, 99) / 10;
            } else if(divisor === 100) {
                base6 = R(100, 999) / 10;
            } else {
                base6 = R(1000, 9999) / 10;
            }
            const result6 = base6 / divisor;
            return {
                q: `${result6.toFixed(4).replace(/\.?0+$/, '')}„ÅØ${base6.toFixed(1)}„ÅÆ‰ΩïÂàÜ„ÅÆ‰∏Ä„Åß„Åô„ÅãÔºü`,
                a: divisor.toString(),
                unit: "ÂàÜ„ÅÆ‰∏Ä",
                type:'normal'
            };

        case 7: // Â∞èÊï∞„ÅÆÊßãÊàê
            const unitType=R(0,2);
            let unit, unitText, count, decimal;

            if(unitType===0){
                unit=0.1;
                unitText="0.1";
                count=R(10,999);
                decimal=count*0.1;
            }else if(unitType===1){
                unit=0.01;
                unitText="0.01";
                count=R(100,999);
                decimal=count*0.01;
            }else{
                unit=0.001;
                unitText="0.001";
                count=R(100,999);
                decimal=count*0.001;
            }

            return {
                q:`${decimal.toFixed(3).replace(/\.?0+$/,'')}„ÅØ${unitText}„Çí„ÅÑ„Åè„Å§ „ÅÇ„Å§„ÇÅ„Åü „Åã„Åö„Åß„Åó„Çá„ÅÜÔºü`,
                a:count.toString(),
                unit:"„Åì",
                type:'normal'
            };

        case 8: // Â∞èÊï∞„ÅÆË∂≥„ÅóÁÆó
            const add1=R(100,999)/100;
            const add2=R(100,999)/100;
            return {
                q:`${add1} + ${add2} =`,
                a:(add1+add2).toFixed(3).replace(/\.?0+$/,''),
                type:'normal'
            };

        case 9: // Â∞èÊï∞„ÅÆ„Å≤„ÅçÁÆó
            const sub1=R(500,999)/100;
            const sub2=R(100,400)/100;
            return {
                q:`${sub1} - ${sub2} =`,
                a:(sub1-sub2).toFixed(3).replace(/\.?0+$/,''),
                type:'normal'
            };

        case 10: // Â∞èÊï∞ÊñáÁ´†ÂïèÈ°å
            const problems10=[
                ()=>{
                    const ribbon1=R(15,35)/10;
                    const ribbon2=R(10,25)/10;
                    const operation=R(0,1);
                    if(operation===0){
                        return {
                            q:`Ëµ§„ÅÑ„É™„Éú„É≥„ÅÆÈï∑„Åï„ÅØ${ribbon1}m„ÄÅÈùí„ÅÑ„É™„Éú„É≥„ÅÆÈï∑„Åï„ÅØ${ribbon2}m„Åß„Åô„ÄÇ2Êú¨„ÅÆ„É™„Éú„É≥„Çí„Å§„Å™„Åí„Çã„Å®ÂÖ®ÈÉ®„Åß‰Ωïm„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,
                            a:(ribbon1+ribbon2).toFixed(1).replace(/\.?0+$/,''),
                            unit:"m",
                            type:'normal'
                        };
                    }else{
                        const longer=Math.max(ribbon1,ribbon2);
                        const shorter=Math.min(ribbon1,ribbon2);
                        return {
                            q:`Èï∑„ÅÑ„É™„Éú„É≥„ÅØ${longer}m„ÄÅÁü≠„ÅÑ„É™„Éú„É≥„ÅØ${shorter}m„Åß„Åô„ÄÇÈï∑„ÅÑ„É™„Éú„É≥„ÅØÁü≠„ÅÑ„É™„Éú„É≥„Çà„Çä‰ΩïmÈï∑„ÅÑ„Åß„Åô„ÅãÔºü`,
                            a:(longer-shorter).toFixed(1).replace(/\.?0+$/,''),
                            unit:"m",
                            type:'normal'
                        };
                    }
                },
                ()=>{
                    const weight1=R(15,45)/10;
                    const weight2=R(8,25)/10;
                    const operation=R(0,1);
                    if(operation===0){
                        return {
                            q:`„Çä„Çì„Åî„ÅÆÈáç„Åï„ÅØ${weight1}kg„ÄÅ„Åø„Åã„Çì„ÅÆÈáç„Åï„ÅØ${weight2}kg„Åß„Åô„ÄÇ„Çä„Çì„Åî„Å®„Åø„Åã„Çì„ÇíÂêà„Çè„Åõ„Çã„Å®‰Ωïkg„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,
                            a:(weight1+weight2).toFixed(1).replace(/\.?0+$/,''),
                            unit:"kg",
                            type:'normal'
                        };
                    }else{
                        const heavier=Math.max(weight1,weight2);
                        const lighter=Math.min(weight1,weight2);
                        return {
                            q:`Èáç„ÅÑËç∑Áâ©„ÅØ${heavier}kg„ÄÅËªΩ„ÅÑËç∑Áâ©„ÅØ${lighter}kg„Åß„Åô„ÄÇÈáç„ÅÑËç∑Áâ©„ÅØËªΩ„ÅÑËç∑Áâ©„Çà„Çä‰ΩïkgÈáç„ÅÑ„Åß„Åô„ÅãÔºü`,
                            a:(heavier-lighter).toFixed(1).replace(/\.?0+$/,''),
                            unit:"kg",
                            type:'normal'
                        };
                    }
                }
            ];
            return problems10[R(0,problems10.length-1)]();

        case 11: // Â∞èÊï∞„ÅÆËâ≤„ÄÖ„Å™Ë¶ãÊñπ
            const problems11=[
                ()=>{
                    const whole=R(2,8);
                    const decimal=R(10,99)/100;
                    const combined=whole+decimal;
                    return {
                        q:`${combined.toFixed(2)}„ÅØ${whole}„Å®‰Ωï„ÇíÂêà„Çè„Åõ„ÅüÊï∞„Åß„Åô„ÅãÔºü`,
                        a:decimal.toFixed(2).replace(/\.?0+$/,''),
                        type:'normal'
                    };
                },
                ()=>{
                    const base=R(20,89)/10;
                    const diff=R(1,9)/100;
                    const smaller=base-diff;
                    return {
                        q:`${smaller.toFixed(2)}„ÅØ${base.toFixed(1)}„Çà„Çä„Å©„Çå„Å†„ÅëÂ∞è„Åï„ÅÑÊï∞„Åß„Åô„ÅãÔºü`,
                        a:diff.toFixed(2).replace(/\.?0+$/,''),
                        type:'normal'
                    };
                },
                ()=>{
                    const ones=R(1,9);
                    const tenths=R(0,9);
                    const hundredths=R(1,9);
                    return {
                        q:`${ones}.${tenths}${hundredths}„ÅØ1„Çí‚ñ°„Åì„ÄÅ0.1„Çí‚ñ°„Åì„ÄÅ0.01„Çí‚ñ°„ÅìÈõÜ„ÇÅ„ÅüÊï∞„Åß„Åô`,
                        a:`${ones},${tenths},${hundredths}`,
                        type:'multi'
                    };
                },
                ()=>{
                    const decimal=R(10,99)/10;
                    const count=decimal*100;
                    return {
                        q:`${decimal.toFixed(1)}„ÅØ0.01„Çí„ÅÑ„Åè„Å§ÈõÜ„ÇÅ„ÅüÊï∞„Åß„Åô„ÅãÔºü`,
                        a:count.toString(),
                        unit:"„Åì",
                        type:'normal'
                    };
                }
            ];
            return problems11[R(0,problems11.length-1)]();

        default:
            return generateProblem(1);
    }
}

function showLevelSelect(){$("start").style.display="none";$("levelSelect").style.display="block"}
function backToStart(){stopTimer();disableHiddenStage();["start","levelSelect","game","gameover","clear","hiddenClear"].forEach(id=>$(id).style.display="none");$("start").style.display="block";$("timerDisplay").style.display="none"}
function restart(){backToStart()}

function selectLevel(lv){state={score:0,level:lv,prob:null,unit:"",mode:"select",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0};$("levelSelect").style.display="none";$("game").style.display="block";updateDisplay();updateLevelIndicator();nextQ()}

function backToLevelSelect(){stopTimer();$("game").style.display="none";$("levelSelect").style.display="block";$("timerDisplay").style.display="none"}

function selectMode(m){if(m==='hidden'&&!hiddenStageAvailable){alert('Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅØ„Åæ„Å®„ÇÅ„É¢„Éº„Éâ„Çí„ÇØ„É™„Ç¢„Åó„ÅüÁõ¥Âæå„ÅÆ„ÅøÈÄ≤„ÇÅ„Åæ„ÅôÔºÅ');return}if(m==='hidden')state={score:0,level:12,prob:null,unit:"",mode:"hidden",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0};else state={score:0,level:1,prob:null,unit:"",mode:m,lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0};$("start").style.display="none";$("game").style.display="block";updateDisplay();updateLevelIndicator();if(m==='summary'||m==='hidden')startTimer();nextQ()}

function updateDisplay(){
    if(state.mode==='hidden'){
        $("lv").textContent="Èö†„Åó";
        $("lvInfo").textContent="Ë∂ÖÈ´òÈõ£Â∫¶„Çπ„ÉÜ„Éº„Ç∏";
        $("monster").textContent="üëë";
    }else{
        $("lv").textContent=state.level;
        $("lvInfo").textContent=lvNames[state.level-1];
        $("monster").textContent=monsters[state.level-1];
    }
    $("score").textContent=state.score;
    $("levelSelectBtn").style.display=state.mode==='select'?"inline-block":"none";
    
    const bar=$("progressBar");
    if(state.mode==='practice'){
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>üìö Á∑¥Áøí„É¢„Éº„Éâ</strong></div>';
        $("levelProgress").textContent=`„Åì„ÅÆ„É¨„Éô„É´: ${state.lvCount}/5ÂïèÊ≠£Ëß£`;
        bar.className="progress-bar practice";
        bar.style.width=`${(state.lvCount/5)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }else if(state.mode==='select'){
        $("modeDisplay").innerHTML='<div class="mode-info select"><strong>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</strong></div>';
        $("levelProgress").textContent=`ÂïèÈ°åÊï∞: ${state.selectQCount}Âïè`;
        bar.className="progress-bar select";
        bar.style.width=`${Math.min((state.selectQCount/10)*100,100)}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }else if(state.mode==='hidden'){
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</strong></div>';
        $("levelProgress").textContent=`ÂïèÈ°å ${state.hiddenQ+1}/10`;
        bar.className="progress-bar hidden";
        bar.style.width=`${(state.hiddenQ/10)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline";
        $("hiddenQ").textContent=" / 10Âïè‰∏≠";
    }else{
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</strong></div>';
        $("levelProgress").textContent=`ÂïèÈ°å ${state.totalQ+1}/55`;
        bar.className="progress-bar summary";
        bar.style.width=`${(state.totalQ/55)*100}%`;
        $("totalQ").style.display="inline";
        $("totalQ").textContent=" / 55Âïè‰∏≠";
        $("hiddenQ").style.display="none";
    }
}

function updateLevelIndicator(){
    const ind=$("levelIndicator");
    if(state.mode==='hidden'){
        ind.innerHTML="";
        return;
    }
    ind.innerHTML="";
    for(let i=1;i<=11;i++){
        const dot=document.createElement("div");
        dot.className="level-dot";
        dot.textContent=i;
        if(state.completed.has(i))dot.classList.add("completed");
        else if(i===state.level)dot.classList.add("current");
        ind.appendChild(dot);
    }
}

function nextQ(){
    if(state.mode==='hidden'){
        if(state.hiddenQ>=10){
            showHiddenClear();
            return;
        }
    }else if(state.mode==='practice'){
        if(state.lvCount>=5){
            state.completed.add(state.level);
            addPoints(calculateLevelPoints(state.level));
            if(state.level>=11){
                showClear();
                return;
            }
            state.level++;
            state.lvCount=0;
            animate("level-up");
            updateLevelIndicator();
        }
    }else if(state.mode!=='select'){
        if(state.level>=11&&state.qNum>=5){
            showClear();
            return;
        }
        if(state.qNum>=5){
            state.completed.add(state.level);
            addPoints(calculateLevelPoints(state.level));
            state.level++;
            state.qNum=0;
            animate("level-up");
            updateLevelIndicator();
        }
    }
    
    state.prob=generateProblem(state.level);
    state.selectedChoice=null;
    $("q").innerHTML=state.prob.q;
    state.unit=state.prob.unit||"";
    
    clearInputs();
    $("wrong").style.display="none";
    
    if(state.prob.type==='choice'){
        $("answerSections").style.display="none";
        $("positionInputs").style.display="none";
        $("multiInputs").style.display="none";
        $("choiceButtons").style.display="flex";
        document.querySelectorAll('.choice-btn').forEach(btn=>btn.classList.remove('selected'));
    }else if(state.prob.type==='position'){
        $("answerSections").style.display="none";
        $("positionInputs").style.display="flex";
        $("multiInputs").style.display="none";
        $("choiceButtons").style.display="none";
    }else if(state.prob.type==='multi'){
        $("answerSections").style.display="none";
        $("positionInputs").style.display="none";
        $("multiInputs").style.display="flex";
        $("choiceButtons").style.display="none";
    }else{
        $("answerSections").style.display="flex";
        $("positionInputs").style.display="none";
        $("multiInputs").style.display="none";
        $("choiceButtons").style.display="none";
    }
    
    const show=state.unit?"block":"none";
    ["nUnit"].forEach(id=>{
        $(id).textContent=state.unit;
        $(id).style.display=show;
    });
    
    updateDisplay();
    setFocus();
}

function clearInputs(){
    ["norm","ones","tenths","hundredths","thousandths","multi1","multi2","multi3"].forEach(id=>$(id).value="");
}

function animate(cls){
    $("monster").classList.add(cls);
    if(cls==="correct")createFireworks();
    setTimeout(()=>$("monster").classList.remove(cls),cls==="level-up"?3000:1500);
}

function setFocus(){
    setTimeout(()=>{
        if(state.prob?.type==='position')$("ones").focus();
        else if(state.prob?.type==='multi')$("multi1").focus();
        else if(state.prob?.type!=='choice')$("norm").focus();
    },150);
}

function selectChoice(choice){
    state.selectedChoice=choice;
    document.querySelectorAll('.choice-btn').forEach(btn=>btn.classList.remove('selected'));
    event.target.classList.add('selected');
    checkAnswer(choice,state.prob.a,"");
}

function submitNormal(){
    const ans=$("norm").value.trim();
    if(!ans){
        showError("Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
    }
    checkAnswer(ans,state.prob.a,state.unit);
}


function submitPosition(){
    const ones=$("ones").value||"0";
    const tenths=$("tenths").value||"0";
    const hundredths=$("hundredths").value||"0";
    const thousandths=$("thousandths").value||"0";
    const ans=`${ones},${tenths},${hundredths},${thousandths}`;
    checkAnswer(ans,state.prob.a,"");
}

function submitMulti(){
    const multi1=$("multi1").value||"0";
    const multi2=$("multi2").value||"0";
    const multi3=$("multi3").value||"0";
    const ans=`${multi1},${multi2},${multi3}`;
    checkAnswer(ans,state.prob.a,"");
}

function checkAnswer(ans,correct,unit){
    const isCorrect=ans.toString().toLowerCase()===correct.toString().toLowerCase();
    
    if(isCorrect){
        state.score++;
        if(state.mode==='practice')state.lvCount++;
        else if(state.mode==='summary'){state.qNum++;state.totalQ++;}
        else if(state.mode==='hidden')state.hiddenQ++;
        else if(state.mode==='select')state.selectQCount++;
        
        addPoints(calculateCorrectPoints(state.level));
        animate("correct");
        setTimeout(nextQ,1500);
    }else{
        showWrong(correct,unit);
    }
}

function showWrong(correct,unit){
    $("wrongMsg").textContent="„Åæ„Å°„Åå„ÅÑ„Åß„Åô„ÄÇ";
    $("correctText").textContent=correct+(unit?" "+unit:"");
    $("correctAnswer").style.display="block";
    
    if(state.mode==='practice'){
        state.lvCount=0;
        $("practiceMsg").style.display="block";
        $("selectMsg").style.display="none";
        $("backToSelectBtn").style.display="none";
    }else if(state.mode==='select'){
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="block";
        $("backToSelectBtn").style.display="inline-block";
    }else{
        showGameOver();
        return;
    }
    
    $("wrong").style.display="block";
    animate("wrong");
}

function showError(msg){
    const errorDiv=document.createElement('div');
    errorDiv.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;border:2px solid #f44336;z-index:1000;font-size:18px;font-weight:bold;">${msg}</div>`;
    document.body.appendChild(errorDiv);
    setTimeout(()=>errorDiv.remove(),2000);
}

function retry(){nextQ()}
function next(){nextQ()}

function showGameOver(){
    stopTimer();
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode==='summary'||state.mode==='hidden'){
        const elapsed=getElapsedTime();
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(elapsed);
    }
    
    // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊôÇ„ÅØÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà„ÅÆ„ÅøË°®Á§∫
    $("currentPointsGameover").style.display="block";
    $("currentPointsGameoverValue").textContent=totalPoints;
    $("gameoverPoints").style.display="none";
}

function showClear(){
    stopTimer();
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    
    const elapsed=getElapsedTime();
    $("clearTimeValue").textContent=formatTime(elapsed);
    
    if(state.mode==='summary'){
        // „Åæ„Å®„ÇÅ„É¢„Éº„Éâ„ÇØ„É™„Ç¢ÊôÇ„ÅÆ„Éù„Ç§„É≥„Éà„Çí10ÂÄç„Å´Â§âÊõ¥
        const clearPoints=calculateClearPoints(elapsed);
        addPoints(clearPoints);
        enableHiddenStage();
        $("hiddenStageUnlock").style.display="block";
    }
    
    // „ÇØ„É™„Ç¢ÊôÇ„ÅØÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà„ÅÆ„ÅøË°®Á§∫
    $("currentPointsClear").style.display="block";
    $("currentPointsClearValue").textContent=totalPoints;
    $("pointsEarned").style.display="none";
    
    createFireworks();
}

function showHiddenClear(){
    stopTimer();
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
    
    const hiddenPoints=5000;
    addPoints(hiddenPoints);
    unlockTitle('decimalMaster');
    
    // Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÊôÇ„ÇÇÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà„ÅÆ„ÅøË°®Á§∫
    $("currentPointsHidden").style.display="block";
    $("currentPointsHiddenValue").textContent=totalPoints;
    $("hiddenPointsEarned").style.display="none";
    
    createMasterFireworks();
    disableHiddenStage();
}

// „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
document.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
        if($("game").style.display!=="none"){
            if(state.prob?.type==='position')submitPosition();
            else if(state.prob?.type==='multi')submitMulti();
            else if(state.prob?.type!=='choice')submitNormal();
        }
        if($("wrong").style.display!=="none")retry();
    }
});

// ÂàùÊúüÂåñ
window.addEventListener('load',()=>{
    try{
        const savedHiddenStage=localStorage.getItem('hiddenStageAvailable');
        if(savedHiddenStage==='true'){
            enableHiddenStage();
        }
    }catch(e){}
});
</script>
</body>
</html>
