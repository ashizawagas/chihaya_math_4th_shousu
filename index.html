<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 4å¹´ç”Ÿå°æ•°ç‰ˆ with ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ </title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1) rotate(0deg);color:#333}20%{transform:scale(1.5) rotate(90deg);color:#ff0;filter:drop-shadow(0 0 20px #ff0)}40%{transform:scale(2) rotate(180deg);color:#f0f;filter:drop-shadow(0 0 30px #f0f)}60%{transform:scale(2.5) rotate(270deg);color:#0ff;filter:drop-shadow(0 0 40px #0ff)}80%{transform:scale(3) rotate(360deg);color:#0f0;filter:drop-shadow(0 0 50px #0f0)}100%{transform:scale(1) rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}}
@keyframes correct{0%{transform:scale(1);color:#333}25%{transform:scale(1.3) rotate(10deg);color:#0f0;filter:drop-shadow(0 0 15px #0f0)}50%{transform:scale(1.5) rotate(-10deg);color:#00ff00;filter:drop-shadow(0 0 25px #00ff00)}75%{transform:scale(1.3) rotate(5deg);color:#32cd32;filter:drop-shadow(0 0 20px #32cd32)}100%{transform:scale(1);color:gold;filter:drop-shadow(0 0 10px gold)}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer;transition:all 0.3s}
button:hover{background:#45a049}
button:disabled{background:#ccc;cursor:not-allowed;opacity:0.6}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
.mode-btn.hidden{background:#ff6b6b;animation:hiddenPulse 2s infinite}
.mode-btn.hidden:hover{background:#d32f2f}
@keyframes hiddenPulse{0%,100%{transform:scale(1);box-shadow:0 0 10px #ff6b6b}50%{transform:scale(1.05);box-shadow:0 0 20px #ff6b6b}}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
input:disabled{background:#f5f5f5;cursor:not-allowed}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.progress-bar.hidden{background:linear-gradient(45deg,#ff6b6b,#ffd700,#4caf50,#2196f3);background-size:400% 400%;animation:hiddenProgress 3s ease infinite}
@keyframes hiddenProgress{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.mode-info.hidden{background:linear-gradient(45deg,#ffebee,#fff3e0,#e8f5e8,#e3f2fd);color:#d32f2f;border:2px solid #ff6b6b;animation:hiddenGlow 2s infinite}
@keyframes hiddenGlow{0%,100%{box-shadow:0 0 10px rgba(255,107,107,0.3)}50%{box-shadow:0 0 20px rgba(255,107,107,0.6)}}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
.clear-screen.paused{animation-play-state:paused}
@keyframes rainbow{0%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}25%{background:linear-gradient(45deg,#a8e6cf,#dcedc1);transform:scale(1.05)}50%{background:linear-gradient(45deg,#ffd93d,#ff6b6b);transform:scale(1.1)}75%{background:linear-gradient(45deg,#74b9ff,#0984e3);transform:scale(1.05)}100%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:180px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.normal-input input{width:100px;text-align:center}
.unit-display{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;transition:all 0.3s}
.submit-btn:hover{background:#45a049}
.submit-btn:disabled{background:#ccc;cursor:not-allowed;opacity:0.6}
.choice-buttons{display:flex;justify-content:center;gap:20px;margin:20px 0}
.choice-btn{padding:15px 30px;font-size:20px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;min-width:120px;transition:all 0.3s}
.choice-btn:hover{background:#1976d2}
.choice-btn:disabled{background:#ccc;cursor:not-allowed;opacity:0.6}
.choice-btn.selected{background:#ff9800;transform:scale(1.05)}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.level-select{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;max-width:600px;margin:20px auto}
.level-btn{padding:15px;background:#e3f2fd;border:2px solid #2196f3;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:all 0.3s;position:relative}
.level-btn:hover{background:#2196f3;color:white;transform:scale(1.05)}
.level-btn.cleared{background:#e8f5e8;border-color:#4caf50}
.level-btn.cleared:hover{background:#4caf50;color:white}
.level-btn h4{margin:5px 0;font-size:16px}
.level-btn p{margin:5px 0;font-size:12px;opacity:0.8}
.clear-mark{position:absolute;top:5px;right:5px;font-size:24px;font-weight:bold;animation:clearGlow 2s infinite}
@keyframes clearGlow{0%,100%{transform:scale(1);filter:drop-shadow(0 0 5px rgba(255,215,0,0.8))}50%{transform:scale(1.1);filter:drop-shadow(0 0 15px rgba(255,215,0,1))}}
.correct-celebration{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;background:radial-gradient(circle,#ff0,#f00);border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{0%{transform:scale(1);opacity:1}100%{transform:scale(20);opacity:0}}
.nav-buttons{display:flex;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.nav-btn{background:#6c757d;color:white;padding:8px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
.nav-btn:hover{background:#5a6268}
.timer{font-size:20px;font-weight:bold;color:#d32f2f;margin:10px 0;padding:10px;background:white;border-radius:8px;border:2px solid #f44336}
.points-display{background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:15px;border-radius:10px;margin:15px 0;border:3px solid #ff6b6b;font-weight:bold;font-size:18px;animation:pointsGlow 2s infinite}
@keyframes pointsGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5)}50%{box-shadow:0 0 30px rgba(255,215,0,0.8)}}
.points-earned{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50;font-weight:bold;animation:pointsEarn 2s}
@keyframes pointsEarn{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.session-points{background:#e3f2fd;color:#1976d2;padding:8px;border-radius:6px;margin:5px 0;border:1px solid #2196f3;font-size:14px}
.player-id{background:#f3e5f5;color:#7b1fa2;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #9c27b0;font-size:14px;font-weight:bold}
.position-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0}
.position-inputs span{font-size:18px;margin:0 5px}
.position-inputs input{width:80px;font-size:18px}
.multi-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0;flex-wrap:wrap}
.multi-inputs span{font-size:18px;margin:0 5px}
.multi-inputs input{width:80px;font-size:18px}
.hidden-stage-unlock{background:linear-gradient(45deg,#ff6b6b,#ffd700);color:white;font-weight:bold;animation:hiddenUnlock 3s infinite}
@keyframes hiddenUnlock{0%,100%{transform:scale(1);box-shadow:0 0 15px rgba(255,107,107,0.5)}50%{transform:scale(1.1);box-shadow:0 0 30px rgba(255,215,0,0.8)}}
@keyframes titleGlow{0%,100%{transform:scale(1);box-shadow:0 0 20px #ffd700}50%{transform:scale(1.05);box-shadow:0 0 40px #ffd700,0 0 60px #ff6b6b}}
@keyframes masterCelebration{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.5) rotate(90deg);filter:hue-rotate(90deg)}50%{transform:scale(2) rotate(180deg);filter:hue-rotate(180deg)}75%{transform:scale(1.5) rotate(270deg);filter:hue-rotate(270deg)}100%{transform:scale(1) rotate(360deg);filter:hue-rotate(360deg)}}
.master-celebration{animation:masterCelebration 4s ease-in-out}
.master-celebration.paused{animation-play-state:paused}
.chart-container{background:white;padding:15px;border-radius:10px;margin:15px 0;border:2px solid #2196f3;position:relative;width:100%;max-width:600px;height:250px;margin:15px auto}
.chart-container h3{color:#2196f3;margin:0 0 10px 0;font-size:16px}
.chart-canvas{width:100%!important;height:200px!important}
.level-clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef,#a8e6cf,#dcedc1);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
.level-clear-screen.paused{animation-play-state:paused}

/* ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.bonus-game-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
    background-size: 400% 400%;
    animation: gradientShift 8s ease infinite;
    z-index: 3000;
    display: none;
    align-items: center;
    justify-content: center;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.bonus-game-content {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 30px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    text-align: center;
    max-width: 600px;
    width: 90%;
    position: relative;
    overflow: hidden;
}

.bonus-game-content::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shine 3s linear infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.bonus-game-content h1 {
    color: #ff6b6b;
    font-size: 2.5em;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

.bonus-shooting-area {
    position: relative;
    width: 100%;
    height: 400px;
    background: linear-gradient(to bottom, #87ceeb, #98fb98);
    border-radius: 15px;
    overflow: hidden;
    margin: 20px 0;
}

.bonus-player {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: #ff6b6b;
    border-radius: 50%;
    cursor: pointer;
    transition: left 0.1s ease;
}

.bonus-falling-number {
    position: absolute;
    width: 50px;
    height: 50px;
    background: linear-gradient(45deg, #feca57, #ff9ff3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    font-size: 18px;
}

.bonus-bullet {
    position: absolute;
    width: 8px;
    height: 15px;
    background: #ff6b6b;
    border-radius: 4px;
}

.bonus-score {
    font-size: 1.5em;
    color: #333;
    margin: 10px 0;
    font-weight: bold;
}

.bonus-timer {
    font-size: 1.3em;
    color: #ff6b6b;
    margin: 10px 0;
    font-weight: bold;
}

.bonus-instructions {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 15px;
    margin: 15px 0;
    border: 2px solid #4ecdc4;
    font-size: 1em;
    color: #333;
    line-height: 1.4;
}

.bonus-controls-info {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
    font-size: 0.9em;
    color: #666;
}

.bonus-start-btn {
    background: linear-gradient(45deg, #4ecdc4, #7dd3c0);
    color: white;
    border: none;
    padding: 25px 50px;
    margin: 20px;
    border-radius: 30px;
    font-size: 1.5em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    animation: pulse 2s ease-in-out infinite;
}

.bonus-start-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 15px 30px rgba(0,0,0,0.4);
    background: linear-gradient(45deg, #7dd3c0, #a8e6cf);
}

.bonus-back-btn {
    background: linear-gradient(45deg, #95a5a6, #bdc3c7);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 15px;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
}

.bonus-back-btn:hover {
    transform: scale(1.1);
}

.bonus-target-display {
    background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
    color: white;
    border-radius: 20px;
    padding: 25px;
    margin: 20px 0;
    border: 3px solid #ff4757;
    box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3);
    animation: glow 2s ease-in-out infinite;
}

.bonus-target-display h3 {
    font-size: 1.8em;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.bonus-target-display .target-number {
    font-size: 3em;
    font-weight: bold;
    margin: 10px 0;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
}

@keyframes glow {
    0%, 100% { box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3); }
    50% { box-shadow: 0 15px 30px rgba(255, 71, 87, 0.6); }
}

.bonus-stars {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

.bonus-star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle 2s ease-in-out infinite;
}

@keyframes twinkle {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

.bonus-level-info {
    background: linear-gradient(45deg, #4ecdc4, #7dd3c0);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin: 15px 0;
    font-size: 1.2em;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<h1>ğŸ§® åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 4å¹´ç”Ÿå°æ•°ç‰ˆ</h1>

<div id="start">
<h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div id="playerIdDisplay" class="player-id" style="display:none">ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ID: <span id="playerId"></span></div>
<div id="pointsDisplay" class="points-display" style="display:none">ğŸ’° ç·ãƒã‚¤ãƒ³ãƒˆ: <span id="totalPoints">0</span>P</div>
<div class="info">
<div class="mode-info select"><h3>ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</h3><p>â€¢ å¥½ããªãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ç·´ç¿’<br>â€¢ 10å•é€£ç¶šæ­£è§£ã§ã‚¯ãƒªã‚¢<br>â€¢ é–“é•ãˆã‚‹ã¨ã‚«ã‚¦ãƒ³ãƒˆ0ã«æˆ»ã‚‹<br>â€¢ æ­£è§£ã§ãƒã‚¤ãƒ³ãƒˆç²å¾—</p></div>
<div class="mode-info practice"><h3>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h3><p>â€¢ å„ãƒ¬ãƒ™ãƒ«ã§5å•é€£ç¶šæ­£è§£ã§æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸<br>â€¢ é–“é•ãˆãŸã‚‰ãã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚‹<br>â€¢ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆ<br>â€¢ <strong>ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ ï¼</strong><br>â€¢ <strong>é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®3å€ã®ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼</strong></p></div>
<div class="mode-info summary"><h3>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</h3><p>â€¢ å…¨11ãƒ¬ãƒ™ãƒ«Ã—å„5å•ï¼è¨ˆ55å•ã«æŒ‘æˆ¦<br>â€¢ ä¸€å•ã§ã‚‚é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼<br>â€¢ ã‚¯ãƒªã‚¢æ™‚é–“ã«å¿œã˜ã¦å¤§é‡ãƒã‚¤ãƒ³ãƒˆç²å¾—<br>â€¢ <strong>ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ ï¼</strong><br>â€¢ <strong>ã‚¯ãƒªã‚¢ã§éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸è§£æ”¾ï¼</strong></p></div>
<div id="hiddenModeInfo" class="mode-info hidden" style="display:none"><h3>ğŸ‘‘ éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸</h3><p>â€¢ è¶…é«˜é›£åº¦ã®å°æ•°å•é¡Œã«æŒ‘æˆ¦<br>â€¢ å…¨10å•ã‚¯ãƒªã‚¢ã§ã€Œå°æ•°ãƒã‚¹ã‚¿ãƒ¼ã€ã®ç§°å·ç²å¾—<br>â€¢ æ´¾æ‰‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ç¥ç¦ï¼</p></div>
</div>
<button class="mode-btn select" onclick="showLevelSelect()">ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn practice" onclick="selectMode('practice')">ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn" onclick="selectMode('summary')">ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</button>
<button id="hiddenStageBtn" class="mode-btn hidden" onclick="selectMode('hidden')" style="display:none">ğŸ‘‘ éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸</button>
</div>

<div id="levelSelect" style="display:none">
<h2>ğŸ® ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div class="level-select">
<div class="level-btn" onclick="selectLevel(1)" data-level="1"><h4>ğŸ”„ ãƒ¬ãƒ™ãƒ«1</h4><p>ãŸã‚“ã„ã¸ã‚“ã‹ã‚“</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(2)" data-level="2"><h4>ğŸ”¢ ãƒ¬ãƒ™ãƒ«2</h4><p>å°æ•°ã®ä»•çµ„ã¿</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(3)" data-level="3"><h4>ğŸ“ ãƒ¬ãƒ™ãƒ«3</h4><p>å°æ•°ã®ä½</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(4)" data-level="4"><h4>âš–ï¸ ãƒ¬ãƒ™ãƒ«4</h4><p>å°æ•°ã®å¤§å°</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(5)" data-level="5"><h4>âœ–ï¸ ãƒ¬ãƒ™ãƒ«5</h4><p>å°æ•° ä½•å€ã‹</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(6)" data-level="6"><h4>â— ãƒ¬ãƒ™ãƒ«6</h4><p>å°æ•° ä½•åˆ†ã®ä¸€ã‹</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(7)" data-level="7"><h4>ğŸ”² ãƒ¬ãƒ™ãƒ«7</h4><p>å°æ•°ã®ã“ã†ã›ã„</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(8)" data-level="8"><h4>â• ãƒ¬ãƒ™ãƒ«8</h4><p>å°æ•°ã®è¶³ã—ç®—</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(9)" data-level="9"><h4>â– ãƒ¬ãƒ™ãƒ«9</h4><p>å°æ•°ã®ã²ãç®—</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(10)" data-level="10"><h4>ğŸ“ ãƒ¬ãƒ™ãƒ«10</h4><p>å°æ•°æ–‡ç« å•é¡Œ</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
<div class="level-btn" onclick="selectLevel(11)" data-level="11"><h4>ğŸ‘‘ ãƒ¬ãƒ™ãƒ«11</h4><p>å°æ•°ã®è‰²ã€…ãªè¦‹æ–¹</p><div class="clear-mark" style="display:none">ğŸ†</div></div>
</div>
<button onclick="backToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«ã‚‚ã©ã‚‹</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>ãƒ¬ãƒ™ãƒ«<span id="lv">1</span>/11 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
<div id="sessionPoints" class="session-points" style="display:none">ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³: <span id="sessionPointsValue">0</span>P</div>
</div>

<div id="timerDisplay" class="timer" style="display:none">â±ï¸ çµŒéæ™‚é–“: <span id="timer">00:00</span></div>

<div class="nav-buttons">
<button class="nav-btn" onclick="backToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«ã‚‚ã©ã‚‹</button>
<button class="nav-btn" id="levelSelectBtn" onclick="backToLevelSelect()" style="display:none">ãƒ¬ãƒ™ãƒ«é¸æŠã«ã‚‚ã©ã‚‹</button>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">ğŸ¯</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>ç­”ãˆã‚’å…¥åŠ›</h3>
<div class="normal-input">
<input type="text" id="norm" placeholder="ç­”ãˆã‚’å…¥åŠ›">
<div id="nUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">ç­”ãˆã‚‹</button>
</div>
</div>

<div id="positionInputs" class="position-inputs" style="display:none">
<span>1ã®ä½:</span><input type="number" id="ones" min="0" max="9">
<span>0.1ã®ä½:</span><input type="number" id="tenths" min="0" max="9">
<span>0.01ã®ä½:</span><input type="number" id="hundredths" min="0" max="9">
<span>0.001ã®ä½:</span><input type="number" id="thousandths" min="0" max="9">
<button class="submit-btn" onclick="submitPosition()">ç­”ãˆã‚‹</button>
</div>

<div id="multiInputs" class="multi-inputs" style="display:none">
<span id="multiLabel1">1ã‚’</span><input type="number" id="multi1" min="0" max="99"><span id="multiUnit1">ã“</span>
<span id="multiLabel2">0.1ã‚’</span><input type="number" id="multi2" min="0" max="99"><span id="multiUnit2">ã“</span>
<span id="multiLabel3">0.01ã‚’</span><input type="number" id="multi3" min="0" max="99"><span id="multiUnit3">ã“</span>
<button class="submit-btn" onclick="submitMulti()">ç­”ãˆã‚‹</button>
</div>

<div id="choiceButtons" class="choice-buttons" style="display:none">
<button class="choice-btn" onclick="selectChoice('left')">å·¦</button>
<button class="choice-btn" onclick="selectChoice('right')">å³</button>
</div>

<div id="wrong" style="display:none">
<div id="wrongMsg" class="error-msg">ã¾ã¡ãŒã„ã§ã™ã€‚</div>
<div id="correctAnswer" class="correct-answer" style="display:none"><strong>æ­£è§£ï¼š</strong><span id="correctText"></span></div>
<div id="practiceMsg" style="display:none"><p>ã“ã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚Šã¾ã™ã€‚é ‘å¼µã£ã¦ï¼</p></div>
<div id="selectMsg" style="display:none"><p>ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼</p></div>
<button onclick="retry()">ã‚‚ã†ä¸€åº¦</button>
<button onclick="next()">ã¤ãã¸</button>
<button id="backToSelectBtn" onclick="backToLevelSelect()" style="display:none">ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
</div>

<div class="status">
<span>ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 55å•ä¸­</span>
<span id="hiddenQ" style="display:none"> / 10å•ä¸­</span>
</div>
</div>

<div id="levelClear" style="display:none" class="level-clear-screen">
<h1>ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h1>
<div class="monster" style="font-size:120px">ğŸ†</div>
<h2>ãŠã‚ã§ã¨ã†ï¼ãƒ¬ãƒ™ãƒ«<span id="clearedLevel"></span>åˆ¶è¦‡ï¼</h2>
<div class="info">
<p>10å•é€£ç¶šæ­£è§£é”æˆï¼</p>
<p>æ­£è§£æ•°: <span id="levelClearScore"></span>å•</p>
<div id="levelClearPoints" class="points-earned">ğŸ‰ ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: <span id="levelClearPointsValue">0</span>P</div>
<div id="currentPointsLevelClear" class="points-display">ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span id="currentPointsLevelClearValue">0</span>P</div>
</div>
<div id="levelClearChartContainer" class="chart-container">
<h3>ğŸ“ˆ ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•</h3>
<canvas id="levelClearPointsChart" class="chart-canvas"></canvas>
</div>
<button onclick="backToLevelSelect()">ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
<div class="monster" style="font-size:120px">ğŸ˜µ</div>
<h2>æ®‹å¿µï¼</h2>
<div class="info">
<p>åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="finalLv"></span>/11</p>
<p>æ­£è§£æ•°: <span id="finalScore1"></span>å•</p>
<p id="finalTime" style="display:none">çµŒéæ™‚é–“: <span id="finalTimeValue"></span></p>
<div id="gameoverPoints" class="points-earned">ğŸ‰ ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: <span id="gameoverPointsValue">0</span>P</div>
<div id="currentPointsGameover" class="points-display">ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span id="currentPointsGameoverValue">0</span>P</div>
</div>
<div id="chartContainer" class="chart-container">
<h3>ğŸ“ˆ ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•</h3>
<canvas id="pointsChart" class="chart-canvas"></canvas>
</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h1>
<div class="monster" style="font-size:120px">ğŸ‘‘</div>
<h2>ãŠã‚ã§ã¨ã†ï¼å…¨ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ï¼</h2>
<div class="info">
<p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore2"></span>å•æ­£è§£</p>
<p id="clearTime">ã‚¯ãƒªã‚¢æ™‚é–“: <span id="clearTimeValue"></span></p>
<div id="pointsEarned" class="points-earned">ğŸ‰ ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: <span id="earnedPoints">0</span>P</div>
<div id="currentPointsClear" class="points-display">ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span id="currentPointsClearValue">0</span>P</div>
</div>
<div id="hiddenStageUnlock" class="hidden-stage-unlock" style="display:none;padding:20px;margin:20px;border-radius:15px;">
<h3>ğŸŒŸ éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼ ğŸŒŸ</h3>
<p>ä»Šã™ãéš ã—ã‚¹ãƒ†ãƒ¼ã‚¸ã«æŒ‘æˆ¦ã§ãã¾ã™ï¼</p>
</div>
<div id="clearChartContainer" class="chart-container">
<h3>ğŸ“ˆ ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•</h3>
<canvas id="clearPointsChart" class="chart-canvas"></canvas>
</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<div id="hiddenClear" style="display:none">
<div style="background:linear-gradient(45deg,#ff9a9e,#fecfef,#a8e6cf,#dcedc1);padding:40px;border-radius:20px;animation:rainbow 3s infinite;">
<h1>ğŸŒŸ éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ ğŸŒŸ</h1>
<div class="monster master-celebration" style="font-size:150px;">ğŸ‘‘</div>
<h2>ğŸ† å°æ•°ãƒã‚¹ã‚¿ãƒ¼èª•ç”Ÿï¼ ğŸ†</h2>
<p style="font-size:20px;color:#d32f2f;font-weight:bold;">ã‚ãªãŸã¯çœŸã®å°æ•°ã®é”äººã§ã™ï¼</p>
<div style="margin:20px 0;font-size:18px;">
<p>éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸å…¨10å•å®Œå…¨åˆ¶è¦‡</p>
<p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="hiddenFinalScore"></span>å•æ­£è§£</p>
<div id="hiddenPointsEarned" class="points-earned">ğŸ‰ ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: <span id="hiddenEarnedPoints">0</span>P</div>
<div id="currentPointsHidden" class="points-display">ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span id="currentPointsHiddenValue">0</span>P</div>
</div>
<div id="hiddenChartContainer" class="chart-container">
<h3>ğŸ“ˆ ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•</h3>
<canvas id="hiddenPointsChart" class="chart-canvas"></canvas>
</div>
<button onclick="restart()" style="padding:15px 30px;font-size:20px;background:#4CAF50;color:white;border:none;border-radius:10px;cursor:pointer;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
</div>
</div>

<div id="celebration" class="correct-celebration"></div>

<!-- æ‰‹æ›¸ãè¨ˆç®—ã‚¹ãƒšãƒ¼ã‚¹ -->
<div id="handwritingSpace" style="margin-top:40px;padding:20px;background:#f0f8ff;border-radius:15px;border:3px solid #2196f3">
<div class="info">
<h2 style="color:#2196f3;margin:0 0 15px 0">ğŸ“ æ‰‹æ›¸ãè¨ˆç®—ã‚¹ãƒšãƒ¼ã‚¹</h2>
<p style="margin:0 0 15px 0;color:#666">ãƒã‚¦ã‚¹ã‚„æŒ‡ã§è‡ªç”±ã«è¨ˆç®—å¼ã‚„å›³ã‚’æ›¸ã‘ã¾ã™</p>
</div>
<div style="background:white;border-radius:10px;padding:20px;border:2px solid #2196f3">
<div style="margin-bottom:15px;text-align:center">
<button onclick="clearDrawCanvas()" style="background:#ff9800;color:white;border:none;padding:10px 20px;border-radius:6px;margin:5px;cursor:pointer;font-size:14px">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
</div>
<canvas id="drawArea" width="800" height="400" style="border:2px solid #2196f3;border-radius:8px;background:#fff;touch-action:none;display:block;margin:0 auto;cursor:crosshair;max-width:100%"></canvas>
<div style="font-size:14px;color:#666;margin-top:15px;text-align:center;background:#f8f9fa;padding:10px;border-radius:6px">
ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ç­†ç®—ã‚„å›³ã‚’æã„ã¦å•é¡Œã‚’è§£ã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼å°æ•°ã®ä½å–ã‚Šã‚„è¨ˆç®—éç¨‹ã‚’æ›¸ãã¨ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚
</div>
</div>
</div>

<!-- ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ  -->
<div id="bonusGameContainer" class="bonus-game-container">
<div class="bonus-stars" id="bonusStars"></div>
<div class="bonus-game-content">
<h1>ğŸ¯ ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ ï¼</h1>

<!-- ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ è¨­å®šç”»é¢ -->
<div id="bonusGameSetup">
<div class="bonus-level-info" id="bonusLevelInfo">
ãƒ¬ãƒ™ãƒ«<span id="bonusCurrentLevel">1</span>ã‚¯ãƒªã‚¢è¨˜å¿µï¼
</div>
<div class="bonus-instructions">
<h3>ğŸ¯ ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚²ãƒ¼ãƒ </h3>
<p>æŒ‡å®šã•ã‚ŒãŸä¹ä¹ã®æ®µã®æ•°å­—ã‚’æ’ƒã¡è½ã¨ãã†ï¼åˆ¶é™æ™‚é–“ã¯30ç§’ã§ã™ã€‚</p>
</div>

<div class="bonus-target-display" id="bonusTargetDisplay">
<h3>ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ®µ</h3>
<div class="target-number" id="bonusTargetNumber">?</div>
<p>ã“ã®æ®µã®æ•°å­—ã‚’ç‹™ã£ã¦æ’ƒã¨ã†ï¼</p>
</div>

<div class="bonus-instructions">
<strong>ãƒ«ãƒ¼ãƒ«ï¼š</strong><br>
è¡¨ç¤ºã•ã‚ŒãŸæ®µã®æ•°å­—ã«ã‚ã¦ã‚‹ã¨10ç‚¹ã€ãã®ä»–ã®æ•°å­—ã«ã‚ã¦ã‚‹ã¨ãƒã‚¤ãƒŠã‚¹5ç‚¹ã§ã™ã€‚<br>
åˆ¶é™æ™‚é–“ã¯30ç§’ã§ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ®µã®æ•°å­—ã¯20å€‹ã€ãã®ä»–ã®æ•°å­—ã¯60å€‹è½ã¡ã¦ãã¾ã™ã€‚<br>
<strong>ç²å¾—ã—ãŸãƒã‚¤ãƒ³ãƒˆã¯åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆã®ãƒã‚¤ãƒ³ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ï¼</strong>
</div>

<button class="bonus-start-btn" onclick="startBonusShootingGame()">
ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼
</button>
<button class="bonus-back-btn" onclick="skipBonusGame()">
ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸
</button>
</div>

<!-- ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚²ãƒ¼ãƒ  -->
<div id="bonusShootingGame" style="display:none">
<h2>ğŸ¯ ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼</h2>
<div class="bonus-instructions" id="bonusGameInstructions">
<!-- ã“ã“ã«è©³ç´°ãªèª¬æ˜ãŒå…¥ã‚Šã¾ã™ -->
</div>
<div class="bonus-controls-info">
ç§»å‹•: â†â†’ã‚­ãƒ¼ ã¾ãŸã¯ ã‚¿ãƒƒãƒ | ç™ºå°„: ã‚¹ãƒšãƒ¼ã‚¹ ã¾ãŸã¯ ã‚¨ãƒ³ã‚¿ãƒ¼
</div>
<div class="bonus-timer" id="bonusGameTimer">æ®‹ã‚Šæ™‚é–“: 30ç§’</div>
<div class="bonus-score" id="bonusGameScore">ã‚¹ã‚³ã‚¢: 0</div>
<div class="bonus-shooting-area" id="bonusShootingArea">
<div class="bonus-player" id="bonusPlayer"></div>
</div>
</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id)||{style:{},textContent:'',innerHTML:'',value:'',classList:{add:()=>{},remove:()=>{}},appendChild:()=>{},remove:()=>{},focus:()=>{},disabled:false};
let state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0,isProcessing:false,lastAnswerTime:0,pendingLevelUp:false,waitingForBonus:false};
const monsters=["ğŸ¯","ğŸŒŸ","ğŸ’","ğŸ¨","ğŸª","ğŸ­","ğŸµ","ğŸ¸","ğŸ²","ğŸ‘‘","ğŸŒˆ"];
const lvNames=["ãŸã‚“ã„ã¸ã‚“ã‹ã‚“","å°æ•°ã®ä»•çµ„ã¿","å°æ•°ã®ä½","å°æ•°ã®å¤§å°","å°æ•° ä½•å€ã‹","å°æ•° ä½•åˆ†ã®ä¸€ã‹","å°æ•°ã®ã“ã†ã›ã„","å°æ•°ã®è¶³ã—ç®—","å°æ•°ã®ã²ãç®—","å°æ•°æ–‡ç« å•é¡Œ","å°æ•°ã®è‰²ã€…ãªè¦‹æ–¹"];
let totalPoints=0,hiddenStageAvailable=false,playerId='',selectModeCleared=new Set();

// ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ é–¢é€£ã®å¤‰æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
let bonusGameState = {
    currentTable: 2,
    gameScore: 0,
    targetNumbers: [],
    gameTimer: null,
    timeRemaining: 30,
    bulletSpeed: 5,
    numberSpeed: 1.8,
    playerPosition: 50,
    keys: {},
    shootingAreaWidth: 0,
    targetInterval: null,
    otherInterval: null,
    bullets: [],
    fallingNumbers: [], // ä¿®æ­£: fallingNumbersé…åˆ—ã‚’å¾©å…ƒ
    isActive: false,
    completedLevel: 1
};

// æ‰‹æ›¸ãæç”»æ©Ÿèƒ½ã®å¤‰æ•°
let drawCanvas, drawCtx, isDrawingNow = false;

// ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// UIè¦ç´ ã®ç„¡åŠ¹åŒ–/æœ‰åŠ¹åŒ–
function disableAllInputs() {
    const inputs = ['norm', 'ones', 'tenths', 'hundredths', 'thousandths', 'multi1', 'multi2', 'multi3'];
    const buttons = document.querySelectorAll('.submit-btn, .choice-btn');
    
    inputs.forEach(id => {
        const element = $(id);
        if (element && element.disabled !== undefined) element.disabled = true;
    });
    
    buttons.forEach(btn => btn.disabled = true);
}

function enableAllInputs() {
    const inputs = ['norm', 'ones', 'tenths', 'hundredths', 'thousandths', 'multi1', 'multi2', 'multi3'];
    const buttons = document.querySelectorAll('.submit-btn, .choice-btn');
    
    inputs.forEach(id => {
        const element = $(id);
        if (element && element.disabled !== undefined) element.disabled = false;
    });
    
    buttons.forEach(btn => btn.disabled = false);
}

// æ‰‹æ›¸ãã‚¹ãƒšãƒ¼ã‚¹ã®åˆæœŸåŒ–
function initDrawingSpace() {
    drawCanvas = $("drawArea");
    if (!drawCanvas) return;
    
    drawCtx = drawCanvas.getContext('2d');
    if (!drawCtx) return;
    
    drawCtx.lineCap = 'round';
    drawCtx.lineJoin = 'round';
    drawCtx.lineWidth = 2;
    drawCtx.strokeStyle = '#2196f3';
    
    setupDrawingEvents();
}

function getDrawPos(e) {
    if (!drawCanvas) return {x: 0, y: 0};
    const rect = drawCanvas.getBoundingClientRect();
    
    if (e.touches && e.touches.length > 0) {
        return {
            x: (e.touches[0].clientX - rect.left) * (drawCanvas.width / rect.width),
            y: (e.touches[0].clientY - rect.top) * (drawCanvas.height / rect.height)
        };
    } else {
        return {
            x: (e.clientX - rect.left) * (drawCanvas.width / rect.width),
            y: (e.clientY - rect.top) * (drawCanvas.height / rect.height)
        };
    }
}

function setupDrawingEvents() {
    if (!drawCanvas || !drawCtx) return;
    
    drawCanvas.addEventListener('mousedown', function(e) {
        isDrawingNow = true;
        const pos = getDrawPos(e);
        drawCtx.beginPath();
        drawCtx.moveTo(pos.x, pos.y);
        e.preventDefault();
    });
    
    drawCanvas.addEventListener('mousemove', function(e) {
        if (!isDrawingNow) return;
        const pos = getDrawPos(e);
        drawCtx.lineTo(pos.x, pos.y);
        drawCtx.stroke();
        e.preventDefault();
    });
    
    drawCanvas.addEventListener('mouseup', function(e) {
        isDrawingNow = false;
        drawCtx.beginPath();
        e.preventDefault();
    });
    
    drawCanvas.addEventListener('mouseleave', function(e) {
        isDrawingNow = false;
        drawCtx.beginPath();
    });

    drawCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        isDrawingNow = true;
        const pos = getDrawPos(e);
        drawCtx.beginPath();
        drawCtx.moveTo(pos.x, pos.y);
    }, { passive: false });
    
    drawCanvas.addEventListener('touchmove', function(e) {
        if (!isDrawingNow) return;
        e.preventDefault();
        const pos = getDrawPos(e);
        drawCtx.lineTo(pos.x, pos.y);
        drawCtx.stroke();
    }, { passive: false });
    
    drawCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        isDrawingNow = false;
        drawCtx.beginPath();
    }, { passive: false });
    
    drawCanvas.addEventListener('touchcancel', function(e) {
        e.preventDefault();
        isDrawingNow = false;
        drawCtx.beginPath();
    }, { passive: false });
}

function clearDrawCanvas() {
    if (!drawCtx || !drawCanvas) return;
    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã®ç”Ÿæˆã¨ç®¡ç†
function generatePlayerId(){
    const now=new Date();
    const year=now.getFullYear();
    const month=(now.getMonth()+1).toString().padStart(2,'0');
    const day=now.getDate().toString().padStart(2,'0');
    const hour=now.getHours().toString().padStart(2,'0');
    const minute=now.getMinutes().toString().padStart(2,'0');
    const second=now.getSeconds().toString().padStart(2,'0');
    return`${year}${month}${day}${hour}${minute}${second}`;
}

function initializePlayerId(){
    try{
        playerId=localStorage.getItem('playerId');
        if(!playerId){
            playerId=generatePlayerId();
            localStorage.setItem('playerId',playerId);
        }
    }catch(e){
        playerId=generatePlayerId();
    }
}

// é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒªã‚¢çŠ¶æ³ã‚’ç®¡ç†
function loadSelectModeCleared(){
    try{
        const saved=localStorage.getItem('selectModeCleared');
        if(saved){
            selectModeCleared=new Set(JSON.parse(saved));
        }
    }catch(e){}
}

function saveSelectModeCleared(){
    try{
        localStorage.setItem('selectModeCleared',JSON.stringify([...selectModeCleared]));
    }catch(e){}
}

function markLevelCleared(level){
    selectModeCleared.add(level);
    saveSelectModeCleared();
    updateLevelSelectDisplay();
}

function updateLevelSelectDisplay(){
    for(let i=1;i<=11;i++){
        const btn=document.querySelector(`[data-level="${i}"]`);
        const mark=btn?.querySelector('.clear-mark');
        if(btn&&mark){
            if(selectModeCleared.has(i)){
                btn.classList.add('cleared');
                mark.style.display='block';
            }else{
                btn.classList.remove('cleared');
                mark.style.display='none';
            }
        }
    }
}

// ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã®ç®¡ç†
function savePointsHistory(points){
    try{
        const today=new Date().toISOString().split('T')[0];
        let history=JSON.parse(localStorage.getItem('pointsHistory')||'{}');
        if(!history[today]){
            history[today]=0;
        }
        history[today]+=points;
        localStorage.setItem('pointsHistory',JSON.stringify(history));
    }catch(e){}
}

function getPointsHistory(){
    try{
        return JSON.parse(localStorage.getItem('pointsHistory')||'{}');
    }catch(e){
        return {};
    }
}

function formatPointsValue(value) {
    if (value === 0) return '0P';
    if (value < 1000) return value + 'P';
    if (value < 10000) return (value / 1000).toFixed(1) + 'kP';
    if (value < 100000) return Math.floor(value / 1000) + 'kP';
    if (value < 1000000) return Math.floor(value / 1000) + 'kP';
    return (value / 1000000).toFixed(1) + 'MP';
}

function calculateYAxisMax(maxValue) {
    if (maxValue === 0) return 100;
    if (maxValue <= 100) return Math.ceil(maxValue / 10) * 10;
    if (maxValue <= 1000) return Math.ceil(maxValue / 100) * 100;
    if (maxValue <= 10000) return Math.ceil(maxValue / 1000) * 1000;
    if (maxValue <= 100000) return Math.ceil(maxValue / 10000) * 10000;
    return Math.ceil(maxValue / 100000) * 100000;
}

function calculateStepSize(maxValue) {
    if (maxValue <= 100) return 10;
    if (maxValue <= 500) return 50;
    if (maxValue <= 1000) return 100;
    if (maxValue <= 5000) return 500;
    if (maxValue <= 10000) return 1000;
    if (maxValue <= 50000) return 5000;
    return 10000;
}

function createPointsChart(canvasId){
    const history=getPointsHistory();
    const dates=Object.keys(history).sort();
    const points=dates.map(date=>history[date]);
    
    let cumulativePoints=0;
    const cumulativeData=points.map(point=>{
        cumulativePoints+=point;
        return cumulativePoints;
    });
    
    const ctx=$(canvasId);
    if(!ctx)return;
    
    if(ctx.chart){
        ctx.chart.destroy();
    }
    
    const maxValue = Math.max(...cumulativeData, 0);
    const yAxisMax = calculateYAxisMax(maxValue);
    const stepSize = calculateStepSize(maxValue);
    
    ctx.chart=new Chart(ctx,{
        type:'line',
        data:{
            labels:dates.map(date=>{
                const d=new Date(date);
                return`${d.getMonth()+1}/${d.getDate()}`;
            }),
            datasets:[{
                label:'ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ',
                data:cumulativeData,
                borderColor:'#2196f3',
                backgroundColor:'rgba(33,150,243,0.1)',
                borderWidth:3,
                fill:true,
                tension:0.4,
                pointBackgroundColor:'#2196f3',
                pointBorderColor:'#fff',
                pointBorderWidth:2,
                pointRadius:6,
                pointHoverRadius:8
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{
                    display:true,
                    position:'top',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ: ${formatPointsValue(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales:{
                y:{
                    beginAtZero:true,
                    max: yAxisMax,
                    grid:{
                        color:'rgba(0,0,0,0.1)'
                    },
                    ticks:{
                        stepSize: stepSize,
                        callback:function(value){
                            return formatPointsValue(value);
                        },
                        font: {
                            size: 10
                        },
                        maxTicksLimit: 8
                    }
                }
            },
            elements:{
                point:{
                    hoverBackgroundColor:'#1976d2'
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}


function enableHiddenStage(){hiddenStageAvailable=true;$("hiddenStageBtn").style.display="inline-block";$("hiddenModeInfo").style.display="block"}
function disableHiddenStage(){hiddenStageAvailable=false;$("hiddenStageBtn").style.display="none";$("hiddenModeInfo").style.display="none"}

try{totalPoints=parseInt(localStorage.getItem('totalPoints')||'0')}catch(e){}
const titles={decimalMaster:{name:"å°æ•°ãƒã‚¹ã‚¿ãƒ¼",description:"éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’åˆ¶è¦‡ã—ãŸçœŸã®å°æ•°ã®é”äºº",unlocked:false}};

const R=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
function formatTime(s){const m=Math.floor(s/60);return`${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`}

function calculateClearPoints(clearTime){
    if(clearTime<=300)return 20000;
    else if(clearTime<=600)return 15000;
    else if(clearTime<=900)return 12000;
    else if(clearTime<=1200)return 10000;
    else if(clearTime<=1800)return 8000;
    else return 5000;
}

function calculateLevelPoints(level){
    if(state.mode === 'summary') return level*50;
    else if(state.mode === 'practice') return Math.floor(level*15);
    else return Math.floor(level*5);
}

function calculateCorrectPoints(level){
    if(state.mode === 'summary') return Math.min(level*10,100);
    else if(state.mode === 'practice') return Math.floor(Math.min(level*3,30));
    else return Math.floor(Math.min(level*1,10));
}

function addPoints(points,showAnimation=true){
    totalPoints+=points;
    state.sessionPoints+=points;
    savePointsHistory(points);
    try{localStorage.setItem('totalPoints',totalPoints.toString())}catch(e){}
    $("totalPoints").textContent=totalPoints;
    $("sessionPointsValue").textContent=state.sessionPoints;
    $("pointsDisplay").style.display="block";
    $("sessionPoints").style.display="block";
    if(showAnimation)showPointsAnimation(points);
}

function showPointsAnimation(points){
    const pointsDiv=document.createElement('div');
    pointsDiv.innerHTML=`<div style="position:fixed;top:50%;left:70%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:20px;border-radius:15px;font-size:24px;font-weight:bold;z-index:3000;animation:pointsEarn 2s;border:3px solid #ff6b6b;">+${points}P ç²å¾—ï¼</div>`;
    document.body.appendChild(pointsDiv);
    setTimeout(()=>pointsDiv.remove(),2000);
}

function startTimer(){if(state.mode==='summary'||state.mode==='hidden'){state.startTime=Date.now();$("timerDisplay").style.display="block";state.timerInterval=setInterval(updateTimer,1000)}}
function updateTimer(){if(state.startTime){const elapsed=Math.floor((Date.now()-state.startTime)/1000);$("timer").textContent=formatTime(elapsed)}}
function stopTimer(){if(state.timerInterval){clearInterval(state.timerInterval);state.timerInterval=null}}
function getElapsedTime(){return state.startTime?Math.floor((Date.now()-state.startTime)/1000):0}

function createFireworks(){const celebration=$("celebration");celebration.innerHTML="";for(let i=0;i<15;i++){setTimeout(()=>{const firework=document.createElement("div");firework.className="firework";firework.style.left=Math.random()*window.innerWidth+"px";firework.style.top=Math.random()*window.innerHeight+"px";firework.style.background=`radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${Math.random()*360}, 100%, 70%))`;celebration.appendChild(firework);setTimeout(()=>firework.remove(),2000)},i*100)}for(let i=0;i<30;i++){setTimeout(()=>{const sparkle=document.createElement("div");sparkle.className="sparkle";sparkle.style.left=Math.random()*window.innerWidth+"px";sparkle.style.top=Math.random()*window.innerHeight+"px";celebration.appendChild(sparkle);setTimeout(()=>sparkle.remove(),1500)},i*50)}}

function createMasterFireworks(){const celebration=$("celebration");celebration.innerHTML="";for(let i=0;i<50;i++){setTimeout(()=>{const firework=document.createElement("div");firework.className="firework";firework.style.left=Math.random()*window.innerWidth+"px";firework.style.top=Math.random()*window.innerHeight+"px";firework.style.background=`radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${(Math.random()*360+180)%360}, 100%, 70%))`;firework.style.animation=`firework ${2+Math.random()}s ease-out forwards`;celebration.appendChild(firework);setTimeout(()=>firework.remove(),3000)},i*50)}for(let i=0;i<100;i++){setTimeout(()=>{const star=document.createElement("div");star.innerHTML="â­";star.style.position="absolute";star.style.left=Math.random()*window.innerWidth+"px";star.style.top=Math.random()*window.innerHeight+"px";star.style.fontSize=(10+Math.random()*20)+"px";star.style.animation=`sparkle ${1+Math.random()}s ease-out infinite`;star.style.pointerEvents="none";celebration.appendChild(star);setTimeout(()=>star.remove(),3000)},i*30)}}

function unlockTitle(titleKey){if(titles[titleKey]){titles[titleKey].unlocked=true;try{localStorage.setItem(`title_${titleKey}`,'true')}catch(e){}showTitleUnlock(titles[titleKey])}}

function showTitleUnlock(title){const titleDiv=document.createElement('div');titleDiv.innerHTML=`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center"><div style="background:linear-gradient(45deg,#ffd700,#ffed4e);padding:40px;border-radius:20px;text-align:center;border:5px solid #ff6b6b;animation:titleGlow 2s infinite"><h1 style="color:#d32f2f;font-size:36px;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.5)">ğŸ† ç§°å·ç²å¾—ï¼ ğŸ†</h1><div style="font-size:48px;margin:20px 0">ğŸ‘‘</div><h2 style="color:#1976d2;font-size:28px;margin:10px 0">${title.name}</h2><p style="color:#333;font-size:16px;margin:0">${title.description}</p><button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px;padding:12px 24px;font-size:18px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer">ç¢ºèª</button></div></div>`;document.body.appendChild(titleDiv)}

function pauseAnimationAfterDelay(elementId, delay = 3000) {
    setTimeout(() => {
        const element = $(elementId);
        if (element) {
            element.classList.add('paused');
        }
        const bgElement = element?.querySelector('[style*="animation"]');
        if (bgElement) {
            bgElement.style.animationPlayState = 'paused';
        }
        const masterElement = element?.querySelector('.master-celebration');
        if (masterElement) {
            masterElement.classList.add('paused');
        }
    }, delay);
}

// ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ é–¢é€£ã®é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
function showBonusGame(completedLevel) {
    bonusGameState.completedLevel = completedLevel;
    bonusGameState.currentTable = Math.floor(Math.random() * 8) + 2;
    
    $("bonusCurrentLevel").textContent = completedLevel;
    $("bonusTargetNumber").textContent = `${bonusGameState.currentTable}ã®æ®µ`;
    
    $("bonusGameContainer").style.display = "flex";
    $("bonusGameSetup").style.display = "block";
    $("bonusShootingGame").style.display = "none";
    
    createBonusStars();
}

function createBonusStars() {
    const starsContainer = $("bonusStars");
    starsContainer.innerHTML = "";
    for (let i = 0; i < 30; i++) {
        const star = document.createElement('div');
        star.className = 'bonus-star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
        star.style.animationDelay = Math.random() * 2 + 's';
        starsContainer.appendChild(star);
    }
}

function startBonusShootingGame() {
    $("bonusGameSetup").style.display = "none";
    $("bonusShootingGame").style.display = "block";
    
    bonusGameState.gameScore = 0;
    bonusGameState.timeRemaining = 30;
    bonusGameState.playerPosition = 50;
    bonusGameState.bullets = [];
    bonusGameState.fallingNumbers = []; // ä¿®æ­£: fallingNumbersé…åˆ—ã‚’åˆæœŸåŒ–
    bonusGameState.isActive = true;
    
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°å­—ã‚’è¨­å®š
    bonusGameState.targetNumbers = [];
    for (let i = 1; i <= 9; i++) {
        bonusGameState.targetNumbers.push(bonusGameState.currentTable * i);
    }
    
    const shootingArea = $("bonusShootingArea");
    bonusGameState.shootingAreaWidth = shootingArea.offsetWidth;
    
    const instructionsElement = $("bonusGameInstructions");
    instructionsElement.innerHTML = `
        <strong>${bonusGameState.currentTable}ã®æ®µã®æ•°å­—ã«ã‚ã¦ã‚‹ã¨10ç‚¹ã€ãã®ä»–ã®æ•°å­—ã«ã‚ã¦ã‚‹ã¨ãƒã‚¤ãƒŠã‚¹5ç‚¹ã ã‚ˆ</strong>
    `;
    
    updateBonusGameScore();
    updateBonusTimer();
    updateBonusPlayerPosition();
    startBonusFallingNumbers();
    setupBonusShooting();
    
    bonusGameState.gameTimer = setInterval(() => {
        bonusGameState.timeRemaining--;
        updateBonusTimer();
        if (bonusGameState.timeRemaining <= 0) {
            endBonusShootingGame();
        }
    }, 1000);
}

function updateBonusPlayerPosition() {
    const player = $("bonusPlayer");
    const shootingArea = $("bonusShootingArea");
    
    const playerWidth = 40;
    const maxPosition = shootingArea.offsetWidth - playerWidth;
    const leftPos = Math.max(0, Math.min(maxPosition, (bonusGameState.playerPosition / 100) * shootingArea.offsetWidth - playerWidth / 2));
    
    player.style.left = leftPos + 'px';
    player.style.transform = 'none';
}

function updateBonusTimer() {
    $("bonusGameTimer").textContent = `æ®‹ã‚Šæ™‚é–“: ${bonusGameState.timeRemaining}ç§’`;
}

function updateBonusGameScore() {
    $("bonusGameScore").textContent = `ã‚¹ã‚³ã‚¢: ${bonusGameState.gameScore}`;
}

function startBonusFallingNumbers() {
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°å­—ï¼ˆ30ç§’ã§20å€‹ = 1.5ç§’é–“éš”ï¼‰
    bonusGameState.targetInterval = setInterval(() => {
        if (bonusGameState.timeRemaining > 0 && bonusGameState.isActive) {
            createBonusTargetNumber();
        }
    }, 1500);
    
    // ãã®ä»–ã®æ•°å­—ï¼ˆ30ç§’ã§60å€‹ = 0.5ç§’é–“éš”ï¼‰
    bonusGameState.otherInterval = setInterval(() => {
        if (bonusGameState.timeRemaining > 0 && bonusGameState.isActive) {
            createBonusOtherNumber();
        }
    }, 500);
}

// ä¿®æ­£: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°å­—ç”Ÿæˆæ™‚ã«fallingNumbersé…åˆ—ã«è¿½åŠ 
function createBonusTargetNumber() {
    if (bonusGameState.timeRemaining <= 0 || !bonusGameState.isActive) return;
    
    const shootingArea = $("bonusShootingArea");
    const number = document.createElement('div');
    number.className = 'bonus-falling-number';
    
    const targetNum = bonusGameState.targetNumbers[Math.floor(Math.random() * bonusGameState.targetNumbers.length)];
    number.textContent = targetNum;
    number.dataset.value = targetNum;
    number.dataset.isTarget = 'true';
    
    const numberWidth = 50;
    const maxLeft = shootingArea.offsetWidth - numberWidth;
    number.style.left = Math.random() * maxLeft + 'px';
    number.style.top = '0px';
    
    shootingArea.appendChild(number);
    bonusGameState.fallingNumbers.push(number); // ä¿®æ­£: é…åˆ—ã«è¿½åŠ 
    animateBonusFallingNumber(number);
}

// ä¿®æ­£: ãã®ä»–ã®æ•°å­—ç”Ÿæˆæ™‚ã«fallingNumbersé…åˆ—ã«è¿½åŠ 
function createBonusOtherNumber() {
    if (bonusGameState.timeRemaining <= 0 || !bonusGameState.isActive) return;
    
    const shootingArea = $("bonusShootingArea");
    const number = document.createElement('div');
    number.className = 'bonus-falling-number';
    
    let randomNum;
    do {
        randomNum = Math.floor(Math.random() * 81) + 1;
    } while (bonusGameState.targetNumbers.includes(randomNum));
    
    number.textContent = randomNum;
    number.dataset.value = randomNum;
    number.dataset.isTarget = 'false';
    
    const numberWidth = 50;
    const maxLeft = shootingArea.offsetWidth - numberWidth;
    number.style.left = Math.random() * maxLeft + 'px';
    number.style.top = '0px';
    
    shootingArea.appendChild(number);
    bonusGameState.fallingNumbers.push(number); // ä¿®æ­£: é…åˆ—ã«è¿½åŠ 
    animateBonusFallingNumber(number);
}

// ä¿®æ­£: ç”»é¢å¤–ã«å‡ºãŸæ•°å­—ã‚’é…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
function animateBonusFallingNumber(number) {
    const fallInterval = setInterval(() => {
        const currentTop = parseInt(number.style.top);
        const shootingArea = $("bonusShootingArea");
        
        if (currentTop > shootingArea.offsetHeight || bonusGameState.timeRemaining <= 0 || !bonusGameState.isActive) {
            if (number.parentNode) {
                number.remove();
            }
            // ä¿®æ­£: fallingNumbersé…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
            const numberIndex = bonusGameState.fallingNumbers.indexOf(number);
            if (numberIndex > -1) {
                bonusGameState.fallingNumbers.splice(numberIndex, 1);
            }
            clearInterval(fallInterval);
        } else {
            number.style.top = (currentTop + bonusGameState.numberSpeed) + 'px';
        }
    }, 20);
}

function setupBonusShooting() {
    const shootingArea = $("bonusShootingArea");
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
    shootingArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = shootingArea.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        bonusGameState.playerPosition = Math.max(5, Math.min(95, (x / shootingArea.offsetWidth) * 100));
        updateBonusPlayerPosition();
    });
    
    shootingArea.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const rect = shootingArea.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        bonusGameState.playerPosition = Math.max(5, Math.min(95, (x / shootingArea.offsetWidth) * 100));
        updateBonusPlayerPosition();
    });
    
    shootingArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (bonusGameState.isActive) {
            fireBonusBullet();
        }
    });
    
    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    shootingArea.addEventListener('mousemove', (e) => {
        const rect = shootingArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        bonusGameState.playerPosition = Math.max(5, Math.min(95, (x / shootingArea.offsetWidth) * 100));
        updateBonusPlayerPosition();
    });
    
    shootingArea.addEventListener('click', (e) => {
        if (bonusGameState.timeRemaining > 0 && bonusGameState.isActive) {
            fireBonusBullet();
        }
    });
    
    // ã‚­ãƒ¼ç§»å‹•ã®å‡¦ç†ï¼ˆ16msã”ã¨ã«æ›´æ–°ã§ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹•ï¼‰
    const moveInterval = setInterval(() => {
        if (bonusGameState.timeRemaining <= 0 || !bonusGameState.isActive) {
            clearInterval(moveInterval);
            return;
        }
        
        if (bonusGameState.keys['ArrowLeft'] || bonusGameState.keys['a'] || bonusGameState.keys['A']) {
            bonusGameState.playerPosition = Math.max(5, bonusGameState.playerPosition - 2);
            updateBonusPlayerPosition();
        }
        if (bonusGameState.keys['ArrowRight'] || bonusGameState.keys['d'] || bonusGameState.keys['D']) {
            bonusGameState.playerPosition = Math.min(95, bonusGameState.playerPosition + 2);
            updateBonusPlayerPosition();
        }
    }, 16);
}

function fireBonusBullet() {
    const shootingArea = $("bonusShootingArea");
    const player = $("bonusPlayer");
    const bullet = document.createElement('div');
    bullet.className = 'bonus-bullet';
    
    const playerRect = player.getBoundingClientRect();
    const shootingRect = shootingArea.getBoundingClientRect();
    const bulletX = playerRect.left - shootingRect.left + 16;
    
    bullet.style.left = bulletX + 'px';
    bullet.style.bottom = '50px';
    
    shootingArea.appendChild(bullet);
    bonusGameState.bullets.push(bullet);
    
    const bulletInterval = setInterval(() => {
        const currentBottom = parseInt(bullet.style.bottom);
        if (currentBottom > shootingArea.offsetHeight || bonusGameState.timeRemaining <= 0 || !bonusGameState.isActive) {
            if (bullet.parentNode) {
                bullet.remove();
            }
            const bulletIndex = bonusGameState.bullets.indexOf(bullet);
            if (bulletIndex > -1) {
                bonusGameState.bullets.splice(bulletIndex, 1);
            }
            clearInterval(bulletInterval);
        } else {
            bullet.style.bottom = (currentBottom + bonusGameState.bulletSpeed) + 'px';
            
            // è¡çªåˆ¤å®šã‚’å®Ÿè¡Œã—ã€è¡çªã—ãŸå ´åˆã¯å¼¾ã‚’åœæ­¢
            if (checkBonusCollision(bullet)) {
                if (bullet.parentNode) {
                    bullet.remove();
                }
                const bulletIndex = bonusGameState.bullets.indexOf(bullet);
                if (bulletIndex > -1) {
                    bonusGameState.bullets.splice(bulletIndex, 1);
                }
                clearInterval(bulletInterval);
            }
        }
    }, 20);
}

// ä¿®æ­£: è¡çªåˆ¤å®šã§fallingNumbersé…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
function checkBonusCollision(bullet) {
    const bulletRect = bullet.getBoundingClientRect();
    const numbers = document.querySelectorAll('.bonus-falling-number');
    
    for (let i = 0; i < numbers.length; i++) {
        const number = numbers[i];
        const numberRect = number.getBoundingClientRect();
        
        if (bulletRect.left < numberRect.right &&
            bulletRect.right > numberRect.left &&
            bulletRect.top < numberRect.bottom &&
            bulletRect.bottom > numberRect.top) {
            
            const value = parseInt(number.dataset.value);
            const isTarget = number.dataset.isTarget === 'true';
            
            if (isTarget) {
                bonusGameState.gameScore += 10;
            } else {
                bonusGameState.gameScore = Math.max(0, bonusGameState.gameScore - 5);
            }
            
            updateBonusGameScore();
            
            // æ•°å­—ã‚’å‰Šé™¤
            if (number.parentNode) {
                number.remove();
            }
            
            // ä¿®æ­£: fallingNumbersé…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
            const numberIndex = bonusGameState.fallingNumbers.indexOf(number);
            if (numberIndex > -1) {
                bonusGameState.fallingNumbers.splice(numberIndex, 1);
            }
            
            return true; // è¡çªã—ãŸã“ã¨ã‚’è¿”ã™
        }
    }
    
    return false; // è¡çªã—ãªã‹ã£ãŸ
}

function endBonusShootingGame() {
    bonusGameState.isActive = false;
    
    if (bonusGameState.targetInterval) {
        clearInterval(bonusGameState.targetInterval);
    }
    if (bonusGameState.otherInterval) {
        clearInterval(bonusGameState.otherInterval);
    }
    if (bonusGameState.gameTimer) {
        clearInterval(bonusGameState.gameTimer);
    }
    
    setTimeout(() => {
        const earnedPoints = Math.max(0, bonusGameState.gameScore);
        addPoints(earnedPoints);
        
        hideBonusGame();
        
        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’ç¶šè¡Œ
        if (state.mode === 'practice') {
            if (bonusGameState.completedLevel >= 11) {
                showClear();
            } else {
                state.level++;
                state.lvCount = 0;
                animate("level-up");
                updateLevelIndicator();
                updateDisplay();
                nextQ();
            }
        } else if (state.mode === 'summary') {
            if (bonusGameState.completedLevel >= 11) {
                showClear();
            } else {
                state.level++;
                state.qNum = 0;
                animate("level-up");
                updateLevelIndicator();
                updateDisplay();
                nextQ();
            }
        }
    }, 1000);
}

function skipBonusGame() {
    hideBonusGame();
    
    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’ç¶šè¡Œ
    if (state.mode === 'practice') {
        if (bonusGameState.completedLevel >= 11) {
            showClear();
        } else {
            state.level++;
            state.lvCount = 0;
            animate("level-up");
            updateLevelIndicator();
            updateDisplay();
            nextQ();
        }
    } else if (state.mode === 'summary') {
        if (bonusGameState.completedLevel >= 11) {
            showClear();
        } else {
            state.level++;
            state.qNum = 0;
            animate("level-up");
            updateLevelIndicator();
            updateDisplay();
            nextQ();
        }
    }
}

// ä¿®æ­£: ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã§fallingNumbersé…åˆ—ã‚‚ã‚¯ãƒªã‚¢
function hideBonusGame() {
    $("bonusGameContainer").style.display = "none";
    
    if (bonusGameState.targetInterval) {
        clearInterval(bonusGameState.targetInterval);
        bonusGameState.targetInterval = null;
    }
    if (bonusGameState.otherInterval) {
        clearInterval(bonusGameState.otherInterval);
        bonusGameState.otherInterval = null;
    }
    if (bonusGameState.gameTimer) {
        clearInterval(bonusGameState.gameTimer);
        bonusGameState.gameTimer = null;
    }
    
    bonusGameState.bullets = [];
    bonusGameState.fallingNumbers = []; // ä¿®æ­£: fallingNumbersé…åˆ—ã‚‚ã‚¯ãƒªã‚¢
    bonusGameState.isActive = false;
    
    const shootingArea = $("bonusShootingArea");
    if (shootingArea) {
        shootingArea.querySelectorAll('.bonus-falling-number, .bonus-bullet').forEach(el => {
            if (el.parentNode) {
                el.remove();
            }
        });
    }
}

// å°æ•°å•é¡Œç”Ÿæˆé–¢æ•°
function generateProblem(level){
    if(state.mode==='hidden'){
        const patterns=[
            ()=>{
                const kg=R(5,15);
                const g=R(100,999);
                const mg=R(10,999);
                return{
                    q:`${kg}kg${g}g${mg}mgã‚’ kgã§ ã‚ã‚‰ã‚ã—ã¾ã—ã‚‡ã†`,
                    a:(kg+g/1000+mg/1000000).toFixed(6).replace(/\.?0+$/,''),
                    unit:"kg",
                    type:'normal'
                };
            },
            ()=>{
                const base=R(100,999)/1000;
                const mult=R(1000,10000);
                return{
                    q:`${base.toFixed(3)}ã‚’ä½•å€ã™ã‚‹ã¨${(base*mult).toFixed(0)}ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
                    a:mult.toString(),
                    type:'normal'
                };
            },
            ()=>{
                const a1=R(100,999)/100;
                const a2=R(100,999)/100;
                const a3=R(100,999)/100;
                return{
                    q:`${a1.toFixed(2)} + ${a2.toFixed(2)} - ${a3.toFixed(2)} =`,
                    a:(a1+a2-a3).toFixed(3).replace(/\.?0+$/,''),
                    type:'normal'
                };
            }
        ];
        return patterns[R(0,2)]();
    }

    switch(level){
        case 1:
            const kg=R(1,9);
            const g=R(1,999);
            return {
                q:`${kg}kg${g}gã‚’ kgã§ ã‚ã‚‰ã‚ã—ã¾ã—ã‚‡ã†`,
                a:(kg+g/1000).toFixed(3).replace(/\.?0+$/,''),
                unit:"kg",
                type:'normal'
            };

        case 2:
            const problems2=[
                ()=>({q:"0.1ã¯1ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ",a:"10",unit:"åˆ†ã®ä¸€",type:'normal'}),
                ()=>({q:"0.01ã¯1ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ",a:"100",unit:"åˆ†ã®ä¸€",type:'normal'}),
                ()=>({q:"0.001ã¯1ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ",a:"1000",unit:"åˆ†ã®ä¸€",type:'normal'}),
                ()=>({q:"0.1ã¯ä½•å€ã™ã‚‹ã¨1ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",a:"10",unit:"å€",type:'normal'}),
                ()=>({q:"0.01ã¯ä½•å€ã™ã‚‹ã¨1ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",a:"100",unit:"å€",type:'normal'}),
                ()=>({q:"0.001ã¯ä½•å€ã™ã‚‹ã¨1ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",a:"1000",unit:"å€",type:'normal'})
            ];
            return problems2[R(0,problems2.length-1)]();

        case 3:
            const ones=R(1,9);
            const tenths=R(0,9);
            const hundredths=R(0,9);
            const thousandths=R(0,9);
            return {
                q:`${ones}.${tenths}${hundredths}${thousandths}ã¯1ã‚’ä½•å€‹ã€0.1ã‚’ä½•å€‹ã€0.01ã‚’ä½•å€‹ã€0.001ã‚’ä½•å€‹é›†ã‚ãŸæ•°ã§ã—ã‚‡ã†ï¼Ÿ`,
                a:`${ones},${tenths},${hundredths},${thousandths}`,
                type:'position'
            };

        case 4:
            const patterns=[
                ()=>{
                    const base=R(1,20);
                    const decimal1=R(100,999);
                    const decimal2=R(10,99);
                    const a1=parseFloat(`${base}.${decimal1}`);
                    const a2=parseFloat(`${base}.${decimal2}`);
                    return {a1,a2};
                },
                ()=>{
                    const base=R(10,25);
                    const decimal1=R(100,199);
                    const decimal2=R(1,9);
                    const a1=parseFloat(`${base}.${decimal1}`);
                    const a2=parseFloat(`${base}.0${decimal2}`);
                    return {a1,a2};
                }
            ];

            const pattern=patterns[R(0,patterns.length-1)]();
            let {a1,a2}=pattern;

            while(a1===a2){
                const newPattern=patterns[R(0,patterns.length-1)]();
                a1=newPattern.a1;
                a2=newPattern.a2;
            }

            const question=R(0,1)?"å°ã•ã„ã»ã†":"å¤§ãã„ã»ã†";
            const isLeftSmaller=a1<a2;
            let correctSide;
            if(question==="å°ã•ã„ã»ã†"){
                correctSide=isLeftSmaller?"left":"right";
            }else{
                correctSide=isLeftSmaller?"right":"left";
            }

            return {
                q:`${a1}ã¨${a2}ã§${question}ã‚’é¸ã³ã¾ã—ã‚‡ã†`,
                a:correctSide,
                type:'choice'
            };

        case 5:
            const multipliers = [10, 100, 1000];
            const multiplier = multipliers[R(0, multipliers.length-1)];
            let base5;
            if(multiplier === 10) {
                base5 = R(1, 99) / 100;
            } else if(multiplier === 100) {
                base5 = R(1, 99) / 1000;
            } else {
                base5 = R(1, 99) / 10000;
            }
            const result = base5 * multiplier;
            return {
                q: `${base5.toFixed(4).replace(/\.?0+$/, '')}ã‚’ä½•å€ã™ã‚‹ã¨${result.toFixed(3).replace(/\.?0+$/, '')}ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
                a: multiplier.toString(),
                type:'normal'
            };

        case 6:
            const divisors = [10, 100, 1000];
            const divisor = divisors[R(0, divisors.length-1)];
            let base6;
            if(divisor === 10) {
                base6 = R(10, 99) / 10;
            } else if(divisor === 100) {
                base6 = R(100, 999) / 10;
            } else {
                base6 = R(1000, 9999) / 10;
            }
            const result6 = base6 / divisor;
            return {
                q: `${result6.toFixed(4).replace(/\.?0+$/, '')}ã¯${base6.toFixed(1)}ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ`,
                a: divisor.toString(),
                unit: "åˆ†ã®ä¸€",
                type:'normal'
            };

        case 7:
            const unitType=R(0,2);
            let unit, unitText, count, decimal;
            if(unitType===0){
                unit=0.1;
                unitText="0.1";
                count=R(10,999);
                decimal=count*0.1;
            }else if(unitType===1){
                unit=0.01;
                unitText="0.01";
                count=R(100,999);
                decimal=count*0.01;
            }else{
                unit=0.001;
                unitText="0.001";
                count=R(100,999);
                decimal=count*0.001;
            }

            return {
                q:`${decimal.toFixed(3).replace(/\.?0+$/,'')}ã¯${unitText}ã‚’ã„ãã¤ ã‚ã¤ã‚ãŸ ã‹ãšã§ã—ã‚‡ã†ï¼Ÿ`,
                a:count.toString(),
                unit:"ã“",
                type:'normal'
            };

        case 8:
            const add1=R(100,999)/100;
            const add2=R(100,999)/100;
            return {
                q:`${add1} + ${add2} =`,
                a:(add1+add2).toFixed(3).replace(/\.?0+$/,''),
                type:'normal'
            };

        case 9:
            const sub1=R(500,999)/100;
            const sub2=R(100,400)/100;
            return {
                q:`${sub1} - ${sub2} =`,
                a:(sub1-sub2).toFixed(3).replace(/\.?0+$/,''),
                type:'normal'
            };

        case 10:
            const problems10=[
                ()=>{
                    const ribbon1=R(15,35)/10;
                    const ribbon2=R(10,25)/10;
                    const operation=R(0,1);
                    if(operation===0){
                        return {
                            q:`èµ¤ã„ãƒªãƒœãƒ³ã®é•·ã•ã¯${ribbon1}mã€é’ã„ãƒªãƒœãƒ³ã®é•·ã•ã¯${ribbon2}mã§ã™ã€‚2æœ¬ã®ãƒªãƒœãƒ³ã‚’ã¤ãªã’ã‚‹ã¨å…¨éƒ¨ã§ä½•mã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
                            a:(ribbon1+ribbon2).toFixed(1).replace(/\.?0+$/,''),
                            unit:"m",
                            type:'normal'
                        };
                    }else{
                        const longer=Math.max(ribbon1,ribbon2);
                        const shorter=Math.min(ribbon1,ribbon2);
                        return {
                            q:`é•·ã„ãƒªãƒœãƒ³ã¯${longer}mã€çŸ­ã„ãƒªãƒœãƒ³ã¯${shorter}mã§ã™ã€‚é•·ã„ãƒªãƒœãƒ³ã¯çŸ­ã„ãƒªãƒœãƒ³ã‚ˆã‚Šä½•mé•·ã„ã§ã™ã‹ï¼Ÿ`,
                            a:(longer-shorter).toFixed(1).replace(/\.?0+$/,''),
                            unit:"m",
                            type:'normal'
                        };
                    }
                },
                ()=>{
                    const weight1=R(15,45)/10;
                    const weight2=R(8,25)/10;
                    const operation=R(0,1);
                    if(operation===0){
                        return {
                            q:`ã‚Šã‚“ã”ã®é‡ã•ã¯${weight1}kgã€ã¿ã‹ã‚“ã®é‡ã•ã¯${weight2}kgã§ã™ã€‚ã‚Šã‚“ã”ã¨ã¿ã‹ã‚“ã‚’åˆã‚ã›ã‚‹ã¨ä½•kgã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
                            a:(weight1+weight2).toFixed(1).replace(/\.?0+$/,''),
                            unit:"kg",
                            type:'normal'
                        };
                    }else{
                        const heavier=Math.max(weight1,weight2);
                        const lighter=Math.min(weight1,weight2);
                        return {
                            q:`é‡ã„è·ç‰©ã¯${heavier}kgã€è»½ã„è·ç‰©ã¯${lighter}kgã§ã™ã€‚é‡ã„è·ç‰©ã¯è»½ã„è·ç‰©ã‚ˆã‚Šä½•kgé‡ã„ã§ã™ã‹ï¼Ÿ`,
                            a:(heavier-lighter).toFixed(1).replace(/\.?0+$/,''),
                            unit:"kg",
                            type:'normal'
                        };
                    }
                }
            ];
            return problems10[R(0,problems10.length-1)]();

        case 11:
            const problems11=[
                ()=>{
                    const whole=R(2,8);
                    const decimal=R(10,99)/100;
                    const combined=whole+decimal;
                    return {
                        q:`${combined.toFixed(2)}ã¯${whole}ã¨ä½•ã‚’åˆã‚ã›ãŸæ•°ã§ã™ã‹ï¼Ÿ`,
                        a:decimal.toFixed(2).replace(/\.?0+$/,''),
                        type:'normal'
                    };
                },
                ()=>{
                    const base=R(20,89)/10;
                    const diff=R(1,9)/100;
                    const smaller=base-diff;
                    return {
                        q:`${smaller.toFixed(2)}ã¯${base.toFixed(1)}ã‚ˆã‚Šã©ã‚Œã ã‘å°ã•ã„æ•°ã§ã™ã‹ï¼Ÿ`,
                        a:diff.toFixed(2).replace(/\.?0+$/,''),
                        type:'normal'
                    };
                },
                ()=>{
                    const ones=R(1,9);
                    const tenths=R(0,9);
                    const hundredths=R(1,9);
                    return {
                        q:`${ones}.${tenths}${hundredths}ã¯1ã‚’â–¡ã“ã€0.1ã‚’â–¡ã“ã€0.01ã‚’â–¡ã“é›†ã‚ãŸæ•°ã§ã™`,
                        a:`${ones},${tenths},${hundredths}`,
                        type:'multi'
                    };
                },
                ()=>{
                    const decimal=R(10,99)/10;
                    const count=decimal*100;
                    return {
                        q:`${decimal.toFixed(1)}ã¯0.01ã‚’ã„ãã¤é›†ã‚ãŸæ•°ã§ã™ã‹ï¼Ÿ`,
                        a:count.toString(),
                        unit:"ã“",
                        type:'normal'
                    };
                }
            ];
            return problems11[R(0,problems11.length-1)]();

        default:
            return generateProblem(1);
    }
}

// é€£æ‰“é˜²æ­¢æ©Ÿèƒ½ä»˜ãã®å›ç­”å‡¦ç†é–¢æ•°
function checkAnswer(ans, correct, unit) {
    // é€£æ‰“é˜²æ­¢ãƒã‚§ãƒƒã‚¯
    const now = Date.now();
    if (state.isProcessing || (now - state.lastAnswerTime < 500)) {
        return;
    }
    
    state.isProcessing = true;
    state.lastAnswerTime = now;
    
    const isCorrect = ans.toString().toLowerCase() === correct.toString().toLowerCase();
    
    if (isCorrect) {
        state.score++;
        if (state.mode === 'practice') state.lvCount++;
        else if (state.mode === 'summary') { state.qNum++; state.totalQ++; }
        else if (state.mode === 'hidden') state.hiddenQ++;
        else if (state.mode === 'select') state.selectQCount++;
        
        addPoints(calculateCorrectPoints(state.level));
        animate("correct");
        
        // æ­£è§£æ™‚ã«æ‰‹æ›¸ãã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
        setTimeout(() => {
            clearDrawCanvas();
        }, 1000);
        
        setTimeout(() => {
            state.isProcessing = false;
            
            // ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢åˆ¤å®šã¨ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ ç§»è¡Œ
            if (state.mode === 'practice' && state.lvCount >= 5) {
                state.completed.add(state.level);
                addPoints(calculateLevelPoints(state.level));
                showBonusGame(state.level);
                return;
            } else if (state.mode === 'summary' && state.qNum >= 5) {
                state.completed.add(state.level);
                addPoints(calculateLevelPoints(state.level));
                showBonusGame(state.level);
                return;
            }
            
            nextQ();
        }, 1500);
    } else {
        setTimeout(() => {
            state.isProcessing = false;
            showWrong(correct, unit);
        }, 500);
    }
}

// æ®‹ã‚Šã®é–¢æ•°ç¾¤
function showLevelSelect(){$("start").style.display="none";$("levelSelect").style.display="block";updateLevelSelectDisplay()}
function backToStart(){stopTimer();disableHiddenStage();["start","levelSelect","game","gameover","clear","hiddenClear","levelClear"].forEach(id=>$(id).style.display="none");$("start").style.display="block";$("timerDisplay").style.display="none"}
function restart(){backToStart()}

function selectLevel(lv){state={score:0,level:lv,prob:null,unit:"",mode:"select",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0,isProcessing:false,lastAnswerTime:0,pendingLevelUp:false,waitingForBonus:false};$("levelSelect").style.display="none";$("game").style.display="block";updateDisplay();updateLevelIndicator();nextQ()}

function backToLevelSelect(){
    stopTimer();
    ["game","levelClear"].forEach(id=>$(id).style.display="none");
    $("levelSelect").style.display="block";
    $("timerDisplay").style.display="none";
    updateLevelSelectDisplay();
}

function selectMode(m){
    if(m==='hidden'&&!hiddenStageAvailable){
        alert('éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ãŸç›´å¾Œã®ã¿é€²ã‚ã¾ã™ï¼');
        return;
    }
    if(m==='hidden'){
        state={score:0,level:12,prob:null,unit:"",mode:"hidden",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0,isProcessing:false,lastAnswerTime:0,pendingLevelUp:false,waitingForBonus:false};
    }else{
        state={score:0,level:1,prob:null,unit:"",mode:m,lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedChoice:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0,isProcessing:false,lastAnswerTime:0,pendingLevelUp:false,waitingForBonus:false};
    }
    $("start").style.display="none";
    $("game").style.display="block";
    updateDisplay();
    updateLevelIndicator();
    if(m==='summary'||m==='hidden')startTimer();
    nextQ();
}

function updateDisplay(){
    if(state.mode==='hidden'){
        $("lv").textContent="éš ã—";
        $("lvInfo").textContent="è¶…é«˜é›£åº¦ã‚¹ãƒ†ãƒ¼ã‚¸";
        $("monster").textContent="ğŸ‘‘";
    }else{
        $("lv").textContent=state.level;
        $("lvInfo").textContent=lvNames[state.level-1];
        $("monster").textContent=monsters[state.level-1];
    }
    $("score").textContent=state.score;
    $("levelSelectBtn").style.display=state.mode==='select'?"inline-block":"none";
    
    const bar=$("progressBar");
    if(state.mode==='practice'){
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`ã“ã®ãƒ¬ãƒ™ãƒ«: ${state.lvCount}/5å•æ­£è§£`;
        bar.className="progress-bar practice";
        bar.style.width=`${(state.lvCount/5)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }else if(state.mode==='select'){
        $("modeDisplay").innerHTML='<div class="mode-info select"><strong>ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`é€£ç¶šæ­£è§£: ${state.selectQCount}/10å•`;
        bar.className="progress-bar select";
        bar.style.width=`${(state.selectQCount/10)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }else if(state.mode==='hidden'){
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>ğŸ‘‘ éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸</strong></div>';
        $("levelProgress").textContent=`å•é¡Œ ${state.hiddenQ+1}/10`;
        bar.className="progress-bar hidden";
        bar.style.width=`${(state.hiddenQ/10)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline";
        $("hiddenQ").textContent=" / 10å•ä¸­";
    }else{
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`å•é¡Œ ${state.totalQ+1}/55`;
        bar.className="progress-bar summary";
        bar.style.width=`${(state.totalQ/55)*100}%`;
        $("totalQ").style.display="inline";
        $("totalQ").textContent=" / 55å•ä¸­";
        $("hiddenQ").style.display="none";
    }
}

function updateLevelIndicator(){
    const ind=$("levelIndicator");
    if(state.mode==='hidden'){
        ind.innerHTML="";
        return;
    }
    ind.innerHTML="";
    for(let i=1;i<=11;i++){
        const dot=document.createElement("div");
        dot.className="level-dot";
        dot.textContent=i;
        if(state.completed.has(i))dot.classList.add("completed");
        else if(i===state.level)dot.classList.add("current");
        ind.appendChild(dot);
    }
}

function nextQ(){
    if(state.mode==='hidden'){
        if(state.hiddenQ>=10){
            showHiddenClear();
            return;
        }
    }else if(state.mode==='select'){
        if(state.selectQCount>=10){
            showLevelClear();
            return;
        }
    }
    
    state.prob=generateProblem(state.level);
    state.selectedChoice=null;
    $("q").innerHTML=state.prob.q;
    state.unit=state.prob.unit||"";
    
    clearInputs();
    $("wrong").style.display="none";
    
    if(state.prob.type==='choice'){
        $("answerSections").style.display="none";
        $("positionInputs").style.display="none";
        $("multiInputs").style.display="none";
        $("choiceButtons").style.display="flex";
        document.querySelectorAll('.choice-btn').forEach(btn=>btn.classList.remove('selected'));
    }else if(state.prob.type==='position'){
        $("answerSections").style.display="none";
        $("positionInputs").style.display="flex";
        $("multiInputs").style.display="none";
        $("choiceButtons").style.display="none";
    }else if(state.prob.type==='multi'){
        $("answerSections").style.display="none";
        $("positionInputs").style.display="none";
        $("multiInputs").style.display="flex";
        $("choiceButtons").style.display="none";
    }else{
        $("answerSections").style.display="flex";
        $("positionInputs").style.display="none";
        $("multiInputs").style.display="none";
        $("choiceButtons").style.display="none";
    }
    
    const show=state.unit?"block":"none";
    ["nUnit"].forEach(id=>{
        $(id).textContent=state.unit;
        $(id).style.display=show;
    });
    
    updateDisplay();
    setFocus();
}

function clearInputs(){
    ["norm","ones","tenths","hundredths","thousandths","multi1","multi2","multi3"].forEach(id=>$(id).value="");
}

function animate(cls){
    $("monster").classList.add(cls);
    if(cls==="correct")createFireworks();
    setTimeout(()=>$("monster").classList.remove(cls),cls==="level-up"?3000:1500);
}

function setFocus(){
    setTimeout(()=>{
        if(state.prob?.type==='position')$("ones").focus();
        else if(state.prob?.type==='multi')$("multi1").focus();
        else if(state.prob?.type!=='choice')$("norm").focus();
    },150);
}

function selectChoice(choice){
    state.selectedChoice=choice;
    document.querySelectorAll('.choice-btn').forEach(btn=>btn.classList.remove('selected'));
    event.target.classList.add('selected');
    checkAnswer(choice,state.prob.a,"");
}

function submitNormal(){
    if (state.isProcessing) return;
    const ans=$("norm").value.trim();
    if(!ans){
        showError("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    checkAnswer(ans,state.prob.a,state.unit);
}

function submitPosition(){
    if (state.isProcessing) return;
    const ones=$("ones").value||"0";
    const tenths=$("tenths").value||"0";
    const hundredths=$("hundredths").value||"0";
    const thousandths=$("thousandths").value||"0";
    const ans=`${ones},${tenths},${hundredths},${thousandths}`;
    checkAnswer(ans,state.prob.a,"");
}

function submitMulti(){
    if (state.isProcessing) return;
    const multi1=$("multi1").value||"0";
    const multi2=$("multi2").value||"0";
    const multi3=$("multi3").value||"0";
    const ans=`${multi1},${multi2},${multi3}`;
    checkAnswer(ans,state.prob.a,"");
}

function showWrong(correct,unit){
    $("wrongMsg").textContent="ã¾ã¡ãŒã„ã§ã™ã€‚";
    $("correctText").textContent=correct+(unit?" "+unit:"");
    $("correctAnswer").style.display="block";
    
    if(state.mode==='practice'){
        state.lvCount=0;
        $("practiceMsg").style.display="block";
        $("selectMsg").style.display="none";
        $("backToSelectBtn").style.display="none";
    }else if(state.mode==='select'){
        state.selectQCount=0;
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="block";
        $("backToSelectBtn").style.display="inline-block";
    }else{
        showGameOver();
        return;
    }
    
    $("wrong").style.display="block";
    animate("wrong");
}

function showError(msg){
    const errorDiv=document.createElement('div');
    errorDiv.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;border:2px solid #f44336;z-index:1000;font-size:18px;font-weight:bold;">${msg}</div>`;
    document.body.appendChild(errorDiv);
    setTimeout(()=>errorDiv.remove(),2000);
}

function retry(){nextQ()}
function next(){nextQ()}

function showLevelClear(){
    $("game").style.display="none";
    $("levelClear").style.display="block";
    $("clearedLevel").textContent=state.level;
    $("levelClearScore").textContent=state.score;
    
    const clearBonus=state.level*100;
    addPoints(clearBonus);
    markLevelCleared(state.level);
    
    $("levelClearPointsValue").textContent=clearBonus;
    $("currentPointsLevelClearValue").textContent=totalPoints;
    
    setTimeout(()=>createPointsChart('levelClearPointsChart'),100);
    pauseAnimationAfterDelay('levelClear');
    createFireworks();
}

function showGameOver(){
    stopTimer();
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode==='summary'||state.mode==='hidden'){
        const elapsed=getElapsedTime();
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(elapsed);
    }
    
    $("currentPointsGameover").style.display="block";
    $("currentPointsGameoverValue").textContent=totalPoints;
    $("gameoverPoints").style.display="none";
    
    setTimeout(()=>createPointsChart('pointsChart'),100);
}

function showClear(){
    stopTimer();
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    
    const elapsed=getElapsedTime();
    $("clearTimeValue").textContent=formatTime(elapsed);
    
    if(state.mode==='summary'){
        const clearPoints=calculateClearPoints(elapsed);
        addPoints(clearPoints);
        enableHiddenStage();
        $("hiddenStageUnlock").style.display="block";
    }
    
    $("currentPointsClear").style.display="block";
    $("currentPointsClearValue").textContent=totalPoints;
    $("pointsEarned").style.display="none";
    
    setTimeout(()=>createPointsChart('clearPointsChart'),100);
    pauseAnimationAfterDelay('clear');
    createFireworks();
}

function showHiddenClear(){
    stopTimer();
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
    
    const hiddenPoints=5000;
    addPoints(hiddenPoints);
    unlockTitle('decimalMaster');
    
    $("currentPointsHidden").style.display="block";
    $("currentPointsHiddenValue").textContent=totalPoints;
    $("hiddenPointsEarned").style.display="none";
    
    setTimeout(()=>createPointsChart('hiddenPointsChart'),100);
    pauseAnimationAfterDelay('hiddenClear');
    createMasterFireworks();
    disableHiddenStage();
}

// ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒ¼ãƒ ç”¨ã®ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
document.addEventListener('keydown', (e) => {
    bonusGameState.keys[e.key] = true;
    
    if ((e.key === ' ' || e.key === 'Enter') && bonusGameState.isActive) {
        e.preventDefault();
        if (bonusGameState.timeRemaining > 0) {
            fireBonusBullet();
        }
    }
    
    // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã®ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
    if(e.key==='Enter'){
        if($("game").style.display!=="none"){
            if(state.prob?.type==='position')submitPosition();
            else if(state.prob?.type==='multi')submitMulti();
            else if(state.prob?.type!=='choice')submitNormal();
        }
        if($("wrong").style.display!=="none")retry();
    }
});

document.addEventListener('keyup', (e) => {
    bonusGameState.keys[e.key] = false;
});

window.addEventListener('load',()=>{
    initializePlayerId();
    loadSelectModeCleared();
    initDrawingSpace();
    $("playerIdDisplay").style.display="block";
    $("playerId").textContent=playerId;
    if(totalPoints>0){
        $("pointsDisplay").style.display="block";
        $("totalPoints").textContent=totalPoints;
    }
    updateLevelSelectDisplay();
    
    try{
        const savedHiddenStage=localStorage.getItem('hiddenStageAvailable');
        if(savedHiddenStage==='true'){
            enableHiddenStage();
        }
    }catch(e){}
});
</script>

</body>
</html>
