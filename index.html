<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>デジタル算数ラボ - 4年生専用版</title>
<style>
body{font-family:Arial,sans-serif;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform 0.3s;margin:20px 0}
.monster.level-up{animation:levelUp 2s}
.monster.correct{animation:correct 1s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1)}50%{transform:scale(2)rotate(180deg);color:#ff0}100%{transform:scale(1)rotate(360deg);color:gold}}
@keyframes correct{0%{transform:scale(1)}50%{transform:scale(1.3);color:#0f0}100%{transform:scale(1);color:gold}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2);color:#f00}50%{transform:scale(0.8);color:#f44}75%{transform:scale(1.1);color:#f00}100%{transform:scale(1)}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
button.mode-button{background:#2196F3;padding:15px 30px;font-size:18px;margin:15px}
button.mode-button:hover{background:#1976D2}
button.practice{background:#FF9800}
button.practice:hover{background:#F57C00}
button.summary{background:#9C27B0}
button.summary:hover{background:#7B1FA2}
button.select{background:#4CAF50}
button.select:hover{background:#45a049}
button.home{background:#f44336;margin:5px;padding:8px 16px;font-size:14px}
button.home:hover{background:#d32f2f}
button.back{background:#607d8b;margin:10px;padding:12px 24px;font-size:16px}
button.back:hover{background:#455a64}
button.level-button{background:#4CAF50;padding:15px 30px;font-size:18px;margin:10px;display:block;width:80%;max-width:400px;margin-left:auto;margin-right:auto}
button.level-button:hover{background:#45a049}
button.choice-button{background:#2196F3;padding:15px 30px;font-size:20px;margin:15px;min-width:120px}
button.choice-button:hover{background:#1976D2}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
select{font-size:16px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
.status{margin:15px 0;font-size:18px}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:20px;background:#e3f2fd;border-radius:10px;margin:15px 0;border-left:5px solid #2196F3}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 2s infinite}
@keyframes rainbow{0%,100%{background:linear-gradient(45deg,#ff9a9e,#fecfef)}50%{background:linear-gradient(45deg,#a8e6cf,#dcedc1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.position-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0}
.position-inputs span{font-size:18px;margin:0 5px}
.position-inputs input{width:80px;font-size:18px}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:15px;border-radius:8px;margin:15px 0;font-size:18px;border:2px solid #4caf50}
.wrong-feedback{background:#ffebee;color:#d32f2f;padding:15px;border-radius:8px;margin:15px 0;font-size:18px;border:2px solid #f44336}
.input-with-unit{display:inline-flex;align-items:center;gap:5px}
.unit-display{font-size:18px;font-weight:bold;color:#333;background:#f5f5f5;padding:10px 15px;border:2px solid #ddd;border-radius:5px}
.progress{background:#f0f0f0;border-radius:10px;padding:10px;margin:15px 0}
.progress-bar{background:#4CAF50;height:20px;border-radius:10px;transition:width 0.3s}
.streak-counter{font-size:20px;color:#FF5722;font-weight:bold;margin:10px 0}
.timer{font-size:24px;color:#f44336;font-weight:bold;margin:15px 0;padding:10px;background:#fff;border-radius:10px;border:2px solid #f44336}
.ranking{background:#fff3e0;padding:20px;border-radius:10px;margin:20px 0;border:2px solid #ff9800}
.ranking h3{color:#e65100;margin-bottom:15px}
.ranking-item{padding:12px;margin:8px 0;background:#f5f5f5;border-radius:8px;font-size:16px;line-height:1.4}
.my-rank{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.level-select{padding:20px;background:#e8f5e8;border-radius:10px;margin:15px 0;border-left:5px solid #4CAF50}
.record-time{color:#666;font-size:14px;margin-top:4px}
.level-selection{padding:20px;background:#e8f5e8;border-radius:10px;margin:15px 0;border-left:5px solid #4CAF50}
.choice-area{margin:20px 0}
.multi-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0;flex-wrap:wrap}
.multi-inputs span{font-size:18px;margin:0 5px}
.multi-inputs input{width:80px;font-size:18px}
.select-progress{background:#f0f0f0;border-radius:10px;padding:10px;margin:15px 0}
.select-progress-bar{background:#4CAF50;height:20px;border-radius:10px;transition:width 0.3s}
.select-counter{font-size:20px;color:#4CAF50;font-weight:bold;margin:10px 0}

/* 派手なアニメーション */
.fireworks{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{
0%{transform:translateY(100vh) scale(0);opacity:1}
15%{transform:translateY(20vh) scale(1);opacity:1}
100%{transform:translateY(20vh) scale(0);opacity:0}
}
.particle{position:absolute;width:6px;height:6px;border-radius:50%;animation:particle 1.5s ease-out forwards}
@keyframes particle{
0%{transform:translate(0,0) scale(1);opacity:1}
100%{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0}
}
.sparkle{position:absolute;width:8px;height:8px;background:gold;border-radius:50%;animation:sparkle 1s ease-out forwards;pointer-events:none}
@keyframes sparkle{
0%{transform:scale(0) rotate(0deg);opacity:1}
50%{transform:scale(1.5) rotate(180deg);opacity:1}
100%{transform:scale(0) rotate(360deg);opacity:0}
}
.levelup-explosion{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:1001}
.explosion-ring{position:absolute;border:4px solid;border-radius:50%;animation:explosion-ring 2s ease-out forwards}
@keyframes explosion-ring{
0%{width:0;height:0;opacity:1;border-color:#ff0}
50%{border-color:#f80}
100%{width:800px;height:800px;opacity:0;border-color:#f00}
}
.clear-celebration{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1002}
.confetti{position:absolute;width:10px;height:10px;animation:confetti 3s ease-out forwards}
@keyframes confetti{
0%{transform:translateY(-100vh) rotate(0deg);opacity:1}
100%{transform:translateY(100vh) rotate(720deg);opacity:0}
}
.celebration-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle,rgba(255,215,0,0.3) 0%,transparent 70%);animation:celebration-flash 0.5s ease-in-out 3;pointer-events:none;z-index:999}
@keyframes celebration-flash{
0%,100%{opacity:0}
50%{opacity:1}
}
</style>
</head>
<body>
<h1>🧮 デジタル算数ラボ</h1>

<div id="start">
<h2>小学4年生の算数をマスターしよう！</h2>
<div class="info">
<p><strong>📚 内容：</strong>小数の理解・計算・文章題（11段階レベル制）</p>
<p><strong>🎯 目標：</strong>レベル11でゲームクリア！</p>
</div>
<h3>モードを選択してください</h3>
<div class="level-select">
<h4>🎯 選べるモード</h4>
<p>・好きなレベルを選んで練習<br>
・何度でも挑戦可能<br>
・合計10問正解でクリア！</p>
</div>
<div class="mode-info">
<h4>🔸 練習モード</h4>
<p>・各レベルで5問連続正解でレベルアップ<br>
・間違えても何度でも挑戦可能<br>
・間違えるとそのレベルの連続正解数がリセット</p>
</div>
<div class="mode-info">
<h4>🔸 まとめモード</h4>
<p>・各レベル5問正解でレベルアップ<br>
・一問でも間違えるとゲームオーバー<br>
・全11レベル制覇を目指そう<br>
・タイマー付きでスピード勝負！</p>
</div>
<button class="mode-button select" onclick="showLevelSelect()">🎯 選べるモード</button>
<button class="mode-button practice" onclick="startPractice()">🎓 練習モード</button>
<button class="mode-button summary" onclick="startSummary()">🏆 まとめモード</button>
</div>

<div id="levelSelect" style="display:none">
<h2>🎯 選べるモード - レベル選択</h2>
<div class="info">
<p>好きなレベルを選んで練習しましょう！</p>
</div>
<div class="level-selection">
<h3>レベルを選択してください</h3>
<button class="level-button" onclick="startSelect(1)">レベル1 - たんいへんかん</button>
<button class="level-button" onclick="startSelect(2)">レベル2 - 小数の仕組み</button>
<button class="level-button" onclick="startSelect(3)">レベル3 - 小数の位</button>
<button class="level-button" onclick="startSelect(4)">レベル4 - 小数の大小</button>
<button class="level-button" onclick="startSelect(5)">レベル5 - 小数 何倍か</button>
<button class="level-button" onclick="startSelect(6)">レベル6 - 小数 何分の一か</button>
<button class="level-button" onclick="startSelect(7)">レベル7 - 小数のこうせい</button>
<button class="level-button" onclick="startSelect(8)">レベル8 - 小数の足し算</button>
<button class="level-button" onclick="startSelect(9)">レベル9 - 小数のひき算</button>
<button class="level-button" onclick="startSelect(10)">レベル10 - 小数文章問題</button>
<button class="level-button" onclick="startSelect(11)">レベル11 - 小数の色々な見方</button>
</div>
<button class="back" onclick="goBackToStart()">← もどる</button>
</div>

<div id="game" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<button class="home" onclick="goHome()">🏠 トップ画面にもどる</button>
<div id="timerDisplay" style="display:none" class="timer">⏰ <span id="timerText">00:00</span></div>
</div>
<div class="info">
<span id="modeDisplay"></span> | レベル<span id="lv">1</span>/11 - <span id="lvInfo"></span>
</div>
<div id="practiceProgress" style="display:none">
<div class="progress">
<div class="progress-bar" id="progressBar" style="width:0%"></div>
</div>
<div class="streak-counter">連続正解: <span id="streakCount">0</span>/5</div>
</div>
<div id="summaryProgress" style="display:none">
<div class="progress">
<div class="progress-bar" id="summaryProgressBar" style="width:0%"></div>
</div>
<div class="streak-counter">レベル内正解数: <span id="summaryCount">0</span>/5</div>
</div>
<div id="selectProgress" style="display:none">
<div class="select-progress">
<div class="select-progress-bar" id="selectProgressBar" style="width:0%"></div>
</div>
<div class="select-counter">正解数: <span id="selectCount">0</span>/10</div>
</div>
<div class="monster" id="monster">🎯</div>
<div class="question" id="q"></div>
<div id="answer">
<div id="normalInput">
<div class="input-with-unit">
<input type="text" id="input" placeholder="答えを入力">
<span id="unitDisplay" class="unit-display" style="display:none"></span>
</div>
</div>
<div id="positionInputs" class="position-inputs" style="display:none">
<span>1の位:</span><input type="number" id="ones" min="0" max="9">
<span>0.1の位:</span><input type="number" id="tenths" min="0" max="9">
<span>0.01の位:</span><input type="number" id="hundredths" min="0" max="9">
<span>0.001の位:</span><input type="number" id="thousandths" min="0" max="9">
</div>
<div id="multiInputs" class="multi-inputs" style="display:none">
<span id="multiLabel1">1を</span><input type="number" id="multi1" min="0" max="99"><span id="multiUnit1">こ</span>
<span id="multiLabel2">0.1を</span><input type="number" id="multi2" min="0" max="99"><span id="multiUnit2">こ</span>
<span id="multiLabel3">0.01を</span><input type="number" id="multi3" min="0" max="99"><span id="multiUnit3">こ</span>
</div>
<div id="choiceButtons" class="choice-area" style="display:none">
<button class="choice-button" onclick="selectChoice('left')">左</button>
<button class="choice-button" onclick="selectChoice('right')">右</button>
</div>
<br><button id="submitButton" onclick="submit()">こたえる</button>
</div>
<div id="result" style="display:none">
<div id="correctResult" style="display:none">
<div class="correct-answer">🎉 正解です！</div>
</div>
<div id="wrongResult" style="display:none">
<div class="wrong-feedback">❌ 間違いです</div>
<div id="correctAnswerDisplay" class="correct-answer">
<strong>正解：</strong><span id="correctAnswerText"></span>
</div>
</div>
<button id="nextButton" onclick="nextQ()">つぎへ</button>
</div>
<div class="status">スコア: <span id="score">0</span><span id="hpDisplay" style="display:none"> | 残りチャンス: <span id="hp">1</span></span></div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ゲームオーバー</h1>
<div class="monster" style="font-size:120px">😵</div>
<h2 id="gameoverMsg">残念！間違えてしまいました</h2>
<div class="info">
<p>到達レベル: <span id="finalLevel"></span>/11</p>
<p>獲得スコア: <span id="finalScore1"></span>点</p>
<div id="gameoverTime" style="display:none">
<p>経過時間: <span id="finalTime1"></span></p>
</div>
</div>
<button onclick="goBackToStart()">トップ画面に戻る</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>🎉 ゲームクリア！ 🎉</h1>
<div class="monster" style="font-size:120px">👑</div>
<h2>おめでとう！<span id="clearMessage">全レベル制覇！</span></h2>
<div class="info">
<p>最終スコア: <span id="finalScore2"></span>点</p>
<div id="clearTime" style="display:none">
<p>クリアタイム: <span id="finalTime2"></span></p>
</div>
</div>
<div id="ranking" style="display:none" class="ranking">
<h3>🏆 ランキング</h3>
<div id="myRankDisplay" class="ranking-item my-rank"></div>
<div id="top3Display"></div>
</div>
<button onclick="goBackToStart()">トップ画面に戻る</button>
</div>

<script>
const $=id=>document.getElementById(id);
let score=0,level=1,hp=1,ans,streak=0,summaryLevelCount=0,selectCorrectCount=0,info="",currentProblem,currentUnit="",gameMode="";
let startTime,timerInterval,selectedChoice="";
const monsters=["🎯","🌟","💎","🎨","🎪","🎭","🎵","🎸","🎲","👑","🌈"];
const levelNames=["たんいへんかん","小数の仕組み","小数の位","小数の大小","小数 何倍か","小数 何分の一か","小数のこうせい","小数の足し算","小数のひき算","小数文章問題","小数の色々な見方"];

//-------------------
// 画面遷移・トップ画面復帰時のアニメーション除去
//-------------------
function showLevelSelect(){
  $("start").style.display="none";
  $("levelSelect").style.display="block";
}

function goBackToStart(){
  $("levelSelect").style.display="none";
  $("game").style.display="none";
  $("gameover").style.display="none";
  $("clear").style.display="none";
  $("start").style.display="block";
  stopAndRemoveAnimations();
}

// クリア演出などのアニメーション要素を除去
function stopAndRemoveAnimations() {
  document.querySelectorAll('.clear-celebration, .celebration-flash, .fireworks').forEach(el => el.remove());
  document.body.classList.remove("clear-screen");
}

//-------------------
// 以降は従来のゲームロジック（問題生成、進行、アニメーション等）
//-------------------

// ... ここに元の問題生成関数やタイマー、アニメーション、ゲーム進行の各種関数を貼り付けてください。
// 例：generateProblem, startSelect, startPractice, startSummary, startGame, updateDisplay, nextQ, submit, displayCorrectAnswer, showGameOver, showClear, goHome など
// 省略部分は[1]のコードを参考にしてください。

// 例：クリア演出
function createClearCelebration(){
  const celebration=document.createElement('div');
  celebration.className='clear-celebration';
  document.body.appendChild(celebration);

  const flash=document.createElement('div');
  flash.className='celebration-flash';
  document.body.appendChild(flash);

  for(let i=0;i<50;i++){
    const confetti=document.createElement('div');
    confetti.className='confetti';
    confetti.style.left=Math.random()*window.innerWidth+'px';
    confetti.style.background=`hsl(${Math.random()*360},100%,50%)`;
    confetti.style.animationDelay=Math.random()*2+'s';
    if(Math.random()>0.5){
      confetti.style.borderRadius='0';
      confetti.style.width='15px';
      confetti.style.height='5px';
    }
    celebration.appendChild(confetti);
  }
  createFireworks();
  setTimeout(()=>{
    celebration.remove();
    flash.remove();
  },3000);
}

// ...（他の関数も[1]のまま貼り付けてください）

// 入力欄のEnterキー対応
$("input").addEventListener("keypress",e=>{if(e.key==="Enter")submit()});
["ones","tenths","hundredths","thousandths","multi1","multi2","multi3"].forEach(id=>{
  $(id).addEventListener("keypress",e=>{if(e.key==="Enter")submit()});
});
</script>
</body>
</html>
