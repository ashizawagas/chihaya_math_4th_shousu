<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ‡ã‚¸ã‚¿ãƒ«ç®—æ•°ãƒ©ãƒœ - 4å¹´ç”Ÿå°‚ç”¨ç‰ˆ</title>
<style>
body{font-family:Arial,sans-serif;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform 0.3s;margin:20px 0}
.monster.level-up{animation:levelUp 2s}
.monster.correct{animation:correct 1s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1)}50%{transform:scale(2)rotate(180deg);color:#ff0}100%{transform:scale(1)rotate(360deg);color:gold}}
@keyframes correct{0%{transform:scale(1)}50%{transform:scale(1.3);color:#0f0}100%{transform:scale(1);color:gold}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2);color:#f00}50%{transform:scale(0.8);color:#f44}75%{transform:scale(1.1);color:#f00}100%{transform:scale(1)}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
button.mode-button{background:#2196F3;padding:15px 30px;font-size:18px;margin:15px}
button.mode-button:hover{background:#1976D2}
button.practice{background:#FF9800}
button.practice:hover{background:#F57C00}
button.summary{background:#9C27B0}
button.summary:hover{background:#7B1FA2}
button.select{background:#4CAF50}
button.select:hover{background:#45a049}
button.home{background:#f44336;margin:5px;padding:8px 16px;font-size:14px}
button.home:hover{background:#d32f2f}
button.back{background:#607d8b;margin:10px;padding:12px 24px;font-size:16px}
button.back:hover{background:#455a64}
button.level-button{background:#4CAF50;padding:15px 30px;font-size:18px;margin:10px;display:block;width:80%;max-width:400px;margin-left:auto;margin-right:auto}
button.level-button:hover{background:#45a049}
button.choice-button{background:#2196F3;padding:15px 30px;font-size:20px;margin:15px;min-width:120px}
button.choice-button:hover{background:#1976D2}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
select{font-size:16px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
.status{margin:15px 0;font-size:18px}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:20px;background:#e3f2fd;border-radius:10px;margin:15px 0;border-left:5px solid #2196F3}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 2s infinite}
@keyframes rainbow{0%,100%{background:linear-gradient(45deg,#ff9a9e,#fecfef)}50%{background:linear-gradient(45deg,#a8e6cf,#dcedc1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.position-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0}
.position-inputs span{font-size:18px;margin:0 5px}
.position-inputs input{width:80px;font-size:18px}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:15px;border-radius:8px;margin:15px 0;font-size:18px;border:2px solid #4caf50}
.wrong-feedback{background:#ffebee;color:#d32f2f;padding:15px;border-radius:8px;margin:15px 0;font-size:18px;border:2px solid #f44336}
.input-with-unit{display:inline-flex;align-items:center;gap:5px}
.unit-display{font-size:18px;font-weight:bold;color:#333;background:#f5f5f5;padding:10px 15px;border:2px solid #ddd;border-radius:5px}
.progress{background:#f0f0f0;border-radius:10px;padding:10px;margin:15px 0}
.progress-bar{background:#4CAF50;height:20px;border-radius:10px;transition:width 0.3s}
.streak-counter{font-size:20px;color:#FF5722;font-weight:bold;margin:10px 0}
.timer{font-size:24px;color:#f44336;font-weight:bold;margin:15px 0;padding:10px;background:#fff;border-radius:10px;border:2px solid #f44336}
.ranking{background:#fff3e0;padding:20px;border-radius:10px;margin:20px 0;border:2px solid #ff9800}
.ranking h3{color:#e65100;margin-bottom:15px}
.ranking-item{padding:12px;margin:8px 0;background:#f5f5f5;border-radius:8px;font-size:16px;line-height:1.4}
.my-rank{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.level-select{padding:20px;background:#e8f5e8;border-radius:10px;margin:15px 0;border-left:5px solid #4CAF50}
.record-time{color:#666;font-size:14px;margin-top:4px}
.level-selection{padding:20px;background:#e8f5e8;border-radius:10px;margin:15px 0;border-left:5px solid #4CAF50}
.choice-area{margin:20px 0}
.user-info{padding:20px;background:#fff;border-radius:10px;margin:15px 0;border:2px solid #2196F3}
.multi-inputs{display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0;flex-wrap:wrap}
.multi-inputs span{font-size:18px;margin:0 5px}
.multi-inputs input{width:80px;font-size:18px}
.select-progress{background:#f0f0f0;border-radius:10px;padding:10px;margin:15px 0}
.select-progress-bar{background:#4CAF50;height:20px;border-radius:10px;transition:width 0.3s}
.select-counter{font-size:20px;color:#4CAF50;font-weight:bold;margin:10px 0}
.user-display{background:#e8f5e8;padding:10px;border-radius:8px;margin:10px 0;font-size:16px;border:2px solid #4CAF50}

/* æ´¾æ‰‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.fireworks{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{
0%{transform:translateY(100vh) scale(0);opacity:1}
15%{transform:translateY(20vh) scale(1);opacity:1}
100%{transform:translateY(20vh) scale(0);opacity:0}
}
.particle{position:absolute;width:6px;height:6px;border-radius:50%;animation:particle 1.5s ease-out forwards}
@keyframes particle{
0%{transform:translate(0,0) scale(1);opacity:1}
100%{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0}
}

/* æ­£è§£æ™‚ã®ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.sparkle{position:absolute;width:8px;height:8px;background:gold;border-radius:50%;animation:sparkle 1s ease-out forwards;pointer-events:none}
@keyframes sparkle{
0%{transform:scale(0) rotate(0deg);opacity:1}
50%{transform:scale(1.5) rotate(180deg);opacity:1}
100%{transform:scale(0) rotate(360deg);opacity:0}
}

/* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã®è¶…æ´¾æ‰‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.levelup-explosion{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:1001}
.explosion-ring{position:absolute;border:4px solid;border-radius:50%;animation:explosion-ring 2s ease-out forwards}
@keyframes explosion-ring{
0%{width:0;height:0;opacity:1;border-color:#ff0}
50%{border-color:#f80}
100%{width:800px;height:800px;opacity:0;border-color:#f00}
}

/* ã‚¯ãƒªã‚¢æ™‚ã®è¶…ãƒ‰æ´¾æ‰‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.clear-celebration{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1002}
.confetti{position:absolute;width:10px;height:10px;animation:confetti 3s ease-out forwards}
@keyframes confetti{
0%{transform:translateY(-100vh) rotate(0deg);opacity:1}
100%{transform:translateY(100vh) rotate(720deg);opacity:0}
}

/* ç”»é¢å…¨ä½“ã®ç¥ç¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.celebration-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle,rgba(255,215,0,0.3) 0%,transparent 70%);animation:celebration-flash 0.5s ease-in-out 3;pointer-events:none;z-index:999}
@keyframes celebration-flash{
0%,100%{opacity:0}
50%{opacity:1}
}
</style>
</head>
<body>
<h1>ğŸ§® ãƒ‡ã‚¸ã‚¿ãƒ«ç®—æ•°ãƒ©ãƒœ</h1>

<div id="start">
<h2>å°å­¦4å¹´ç”Ÿã®ç®—æ•°ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†ï¼</h2>
<div class="info">
<p><strong>ğŸ“š å†…å®¹ï¼š</strong>å°æ•°ã®ç†è§£ãƒ»è¨ˆç®—ãƒ»æ–‡ç« é¡Œï¼ˆ11æ®µéšãƒ¬ãƒ™ãƒ«åˆ¶ï¼‰</p>
<p><strong>ğŸ¯ ç›®æ¨™ï¼š</strong>ãƒ¬ãƒ™ãƒ«11ã§ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼</p>
</div>

<h3>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>

<div class="level-select">
<h4>ğŸ¯ é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</h4>
<p>ãƒ»å¥½ããªãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ç·´ç¿’<br>
ãƒ»ä½•åº¦ã§ã‚‚æŒ‘æˆ¦å¯èƒ½<br>
ãƒ»åˆè¨ˆ10å•æ­£è§£ã§ã‚¯ãƒªã‚¢ï¼</p>
</div>

<div class="mode-info">
<h4>ğŸ”¸ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h4>
<p>ãƒ»å„ãƒ¬ãƒ™ãƒ«ã§5å•é€£ç¶šæ­£è§£ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—<br>
ãƒ»é–“é•ãˆã¦ã‚‚ä½•åº¦ã§ã‚‚æŒ‘æˆ¦å¯èƒ½<br>
ãƒ»é–“é•ãˆã‚‹ã¨ãã®ãƒ¬ãƒ™ãƒ«ã®é€£ç¶šæ­£è§£æ•°ãŒãƒªã‚»ãƒƒãƒˆ</p>
</div>
<div class="mode-info">
<h4>ğŸ”¸ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</h4>
<p>ãƒ»å„ãƒ¬ãƒ™ãƒ«5å•æ­£è§£ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—<br>
ãƒ»ä¸€å•ã§ã‚‚é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼<br>
ãƒ»å…¨11ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ã‚’ç›®æŒ‡ãã†<br>
ãƒ»ã‚¿ã‚¤ãƒãƒ¼ä»˜ãã§ã‚¹ãƒ”ãƒ¼ãƒ‰å‹è² ï¼</p>
</div>

<button class="mode-button select" onclick="showLevelSelect()">ğŸ¯ é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-button practice" onclick="startPractice()">ğŸ“ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-button summary" onclick="startSummary()">ğŸ† ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</button>
</div>

<div id="levelSelect" style="display:none">
<h2>ğŸ¯ é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ - ãƒ¬ãƒ™ãƒ«é¸æŠ</h2>
<div class="info">
<p>å¥½ããªãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ç·´ç¿’ã—ã¾ã—ã‚‡ã†ï¼</p>
</div>

<div class="level-selection">
<h3>ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
<button class="level-button" onclick="startSelect(1)">ãƒ¬ãƒ™ãƒ«1 - ãŸã‚“ã„ã¸ã‚“ã‹ã‚“</button>
<button class="level-button" onclick="startSelect(2)">ãƒ¬ãƒ™ãƒ«2 - å°æ•°ã®ä»•çµ„ã¿</button>
<button class="level-button" onclick="startSelect(3)">ãƒ¬ãƒ™ãƒ«3 - å°æ•°ã®ä½</button>
<button class="level-button" onclick="startSelect(4)">ãƒ¬ãƒ™ãƒ«4 - å°æ•°ã®å¤§å°</button>
<button class="level-button" onclick="startSelect(5)">ãƒ¬ãƒ™ãƒ«5 - å°æ•° ä½•å€ã‹</button>
<button class="level-button" onclick="startSelect(6)">ãƒ¬ãƒ™ãƒ«6 - å°æ•° ä½•åˆ†ã®ä¸€ã‹</button>
<button class="level-button" onclick="startSelect(7)">ãƒ¬ãƒ™ãƒ«7 - å°æ•°ã®ã“ã†ã›ã„</button>
<button class="level-button" onclick="startSelect(8)">ãƒ¬ãƒ™ãƒ«8 - å°æ•°ã®è¶³ã—ç®—</button>
<button class="level-button" onclick="startSelect(9)">ãƒ¬ãƒ™ãƒ«9 - å°æ•°ã®ã²ãç®—</button>
<button class="level-button" onclick="startSelect(10)">ãƒ¬ãƒ™ãƒ«10 - å°æ•°æ–‡ç« å•é¡Œ</button>
<button class="level-button" onclick="startSelect(11)">ãƒ¬ãƒ™ãƒ«11 - å°æ•°ã®è‰²ã€…ãªè¦‹æ–¹</button>
</div>

<button class="back" onclick="goBackToStart()">â† ã‚‚ã©ã‚‹</button>
</div>

<div id="game" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<button class="home" onclick="goHome()">ğŸ  ãƒˆãƒƒãƒ—ç”»é¢ã«ã‚‚ã©ã‚‹</button>
<div id="timerDisplay" style="display:none" class="timer">â° <span id="timerText">00:00</span></div>
</div>
<div class="info">
<span id="modeDisplay"></span> | ãƒ¬ãƒ™ãƒ«<span id="lv">1</span>/11 - <span id="lvInfo"></span>
</div>
<div id="practiceProgress" style="display:none">
<div class="progress">
<div class="progress-bar" id="progressBar" style="width:0%"></div>
</div>
<div class="streak-counter">é€£ç¶šæ­£è§£: <span id="streakCount">0</span>/5</div>
</div>
<div id="summaryProgress" style="display:none">
<div class="progress">
<div class="progress-bar" id="summaryProgressBar" style="width:0%"></div>
</div>
<div class="streak-counter">ãƒ¬ãƒ™ãƒ«å†…æ­£è§£æ•°: <span id="summaryCount">0</span>/5</div>
</div>
<div id="selectProgress" style="display:none">
<div class="select-progress">
<div class="select-progress-bar" id="selectProgressBar" style="width:0%"></div>
</div>
<div class="select-counter">æ­£è§£æ•°: <span id="selectCount">0</span>/10</div>
</div>
<div class="monster" id="monster">ğŸ¯</div>
<div class="question" id="q"></div>
<div id="answer">
<div id="normalInput">
<div class="input-with-unit">
<input type="text" id="input" placeholder="ç­”ãˆã‚’å…¥åŠ›">
<span id="unitDisplay" class="unit-display" style="display:none"></span>
</div>
</div>
<div id="positionInputs" class="position-inputs" style="display:none">
<span>1ã®ä½:</span><input type="number" id="ones" min="0" max="9">
<span>0.1ã®ä½:</span><input type="number" id="tenths" min="0" max="9">
<span>0.01ã®ä½:</span><input type="number" id="hundredths" min="0" max="9">
<span>0.001ã®ä½:</span><input type="number" id="thousandths" min="0" max="9">
</div>
<div id="multiInputs" class="multi-inputs" style="display:none">
<span id="multiLabel1">1ã‚’</span><input type="number" id="multi1" min="0" max="99"><span id="multiUnit1">ã“</span>
<span id="multiLabel2">0.1ã‚’</span><input type="number" id="multi2" min="0" max="99"><span id="multiUnit2">ã“</span>
<span id="multiLabel3">0.01ã‚’</span><input type="number" id="multi3" min="0" max="99"><span id="multiUnit3">ã“</span>
</div>
<div id="choiceButtons" class="choice-area" style="display:none">
<button class="choice-button" onclick="selectChoice('left')">å·¦</button>
<button class="choice-button" onclick="selectChoice('right')">å³</button>
</div>
<br><button id="submitButton" onclick="submit()">ã“ãŸãˆã‚‹</button>
</div>
<div id="result" style="display:none">
<div id="correctResult" style="display:none">
<div class="correct-answer">ğŸ‰ æ­£è§£ã§ã™ï¼</div>
</div>
<div id="wrongResult" style="display:none">
<div class="wrong-feedback">âŒ é–“é•ã„ã§ã™</div>
<div id="correctAnswerDisplay" class="correct-answer">
<strong>æ­£è§£ï¼š</strong><span id="correctAnswerText"></span>
</div>
</div>
<button id="nextButton" onclick="nextQ()">ã¤ãã¸</button>
</div>
<div class="status">ã‚¹ã‚³ã‚¢: <span id="score">0</span><span id="hpDisplay" style="display:none"> | æ®‹ã‚Šãƒãƒ£ãƒ³ã‚¹: <span id="hp">1</span></span></div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
<div class="monster" style="font-size:120px">ğŸ˜µ</div>
<h2 id="gameoverMsg">æ®‹å¿µï¼é–“é•ãˆã¦ã—ã¾ã„ã¾ã—ãŸ</h2>
<div class="info">
<p>åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="finalLevel"></span>/11</p>
<p>ç²å¾—ã‚¹ã‚³ã‚¢: <span id="finalScore1"></span>ç‚¹</p>
<div id="gameoverTime" style="display:none">
<p>çµŒéæ™‚é–“: <span id="finalTime1"></span></p>
</div>
</div>
<button onclick="goBackToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h1>
<div class="monster" style="font-size:120px">ğŸ‘‘</div>
<h2>ãŠã‚ã§ã¨ã†ï¼<span id="clearMessage">å…¨ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ï¼</span></h2>
<div class="info">
<p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore2"></span>ç‚¹</p>
<div id="clearTime" style="display:none">
<p>ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ : <span id="finalTime2"></span></p>
</div>
</div>
<div id="ranking" style="display:none" class="ranking">
<h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
<div id="myRankDisplay" class="ranking-item my-rank"></div>
<div id="top3Display"></div>
</div>
<button onclick="goBackToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹</button>
</div>

<script>
const $=id=>document.getElementById(id);
let score=0,level=1,hp=1,ans,streak=0,summaryLevelCount=0,selectCorrectCount=0,info="",currentProblem,currentUnit="",gameMode="";
let startTime,timerInterval,selectedChoice="";
const monsters=["ğŸ¯","ğŸŒŸ","ğŸ’","ğŸ¨","ğŸª","ğŸ­","ğŸµ","ğŸ¸","ğŸ²","ğŸ‘‘","ğŸŒˆ"];
const levelNames=["ãŸã‚“ã„ã¸ã‚“ã‹ã‚“","å°æ•°ã®ä»•çµ„ã¿","å°æ•°ã®ä½","å°æ•°ã®å¤§å°","å°æ•° ä½•å€ã‹","å°æ•° ä½•åˆ†ã®ä¸€ã‹","å°æ•°ã®ã“ã†ã›ã„","å°æ•°ã®è¶³ã—ç®—","å°æ•°ã®ã²ãç®—","å°æ•°æ–‡ç« å•é¡Œ","å°æ•°ã®è‰²ã€…ãªè¦‹æ–¹"];

// ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å€¤ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function rand(min,max,decimals=0){
const num=Math.random()*(max-min)+min;
return decimals?parseFloat(num.toFixed(decimals)):Math.floor(num);
}

// æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
function formatDateTime(timestamp){
const date=new Date(timestamp);
const year=date.getFullYear();
const month=(date.getMonth()+1).toString().padStart(2,'0');
const day=date.getDate().toString().padStart(2,'0');
const hours=date.getHours().toString().padStart(2,'0');
const minutes=date.getMinutes().toString().padStart(2,'0');
return `${year}/${month}/${day} ${hours}:${minutes}`;
}

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã™ã‚‹é–¢æ•°
function stopAllAnimations(){
// bodyè¦ç´ ã‹ã‚‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
document.body.classList.remove("clear-screen");

// å­˜åœ¨ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã‚’å‰Šé™¤
const animationElements = [
'.fireworks',
'.levelup-explosion',
'.clear-celebration',
'.celebration-flash',
'.sparkle'
];

animationElements.forEach(selector => {
const elements = document.querySelectorAll(selector);
elements.forEach(element => element.remove());
});
}

// æ´¾æ‰‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
function createSparkles(){
const colors=['#FFD700','#FF69B4','#00BFFF','#32CD32','#FF4500'];
for(let i=0;i<15;i++){
const sparkle=document.createElement('div');
sparkle.className='sparkle';
sparkle.style.background=colors[Math.floor(Math.random()*colors.length)];
sparkle.style.left=Math.random()*window.innerWidth+'px';
sparkle.style.top=Math.random()*window.innerHeight+'px';
sparkle.style.animationDelay=Math.random()*0.5+'s';
document.body.appendChild(sparkle);
setTimeout(()=>sparkle.remove(),1000);
}
}

function createFireworks(){
const fireworksContainer=document.createElement('div');
fireworksContainer.className='fireworks';
document.body.appendChild(fireworksContainer);

for(let i=0;i<8;i++){
setTimeout(()=>{
const firework=document.createElement('div');
firework.className='firework';
firework.style.left=Math.random()*window.innerWidth+'px';
firework.style.background=`hsl(${Math.random()*360},100%,50%)`;
fireworksContainer.appendChild(firework);

setTimeout(()=>{
for(let j=0;j<12;j++){
const particle=document.createElement('div');
particle.className='particle';
particle.style.left=firework.style.left;
particle.style.top='20vh';
particle.style.background=`hsl(${Math.random()*360},100%,50%)`;
const angle=j*30;
const distance=100+Math.random()*100;
particle.style.setProperty('--dx',Math.cos(angle*Math.PI/180)*distance+'px');
particle.style.setProperty('--dy',Math.sin(angle*Math.PI/180)*distance+'px');
fireworksContainer.appendChild(particle);
setTimeout(()=>particle.remove(),1500);
}
},300);
},i*200);
}
setTimeout(()=>fireworksContainer.remove(),3000);
}

function createLevelUpExplosion(){
const explosion=document.createElement('div');
explosion.className='levelup-explosion';
document.body.appendChild(explosion);

for(let i=0;i<5;i++){
const ring=document.createElement('div');
ring.className='explosion-ring';
ring.style.animationDelay=i*0.1+'s';
ring.style.left='-400px';
ring.style.top='-400px';
explosion.appendChild(ring);
}

setTimeout(()=>explosion.remove(),2000);
}

function createClearCelebration(){
const celebration=document.createElement('div');
celebration.className='clear-celebration';
document.body.appendChild(celebration);

const flash=document.createElement('div');
flash.className='celebration-flash';
document.body.appendChild(flash);

for(let i=0;i<50;i++){
const confetti=document.createElement('div');
confetti.className='confetti';
confetti.style.left=Math.random()*window.innerWidth+'px';
confetti.style.background=`hsl(${Math.random()*360},100%,50%)`;
confetti.style.animationDelay=Math.random()*2+'s';
if(Math.random()>0.5){
confetti.style.borderRadius='0';
confetti.style.width='15px';
confetti.style.height='5px';
}
celebration.appendChild(confetti);
}

createFireworks();
setTimeout(()=>{
celebration.remove();
flash.remove();
},3000);
}

// é¸æŠãƒœã‚¿ãƒ³ç”¨ã®é–¢æ•°
function selectChoice(choice){
selectedChoice=choice;
submit();
}

// å•é¡Œç”Ÿæˆé–¢æ•°
function generateProblem(level){
switch(level){
case 1: // å˜ä½å¤‰æ›
const kg=rand(1,9);
const g=rand(1,999);
return {
q:`${kg}kg${g}gã‚’ kgã§ ã‚ã‚‰ã‚ã—ã¾ã—ã‚‡ã†`,
a:(kg+g/1000).toFixed(3).replace(/\.?0+$/,''),
unit:"kg"
};

case 2: // å°æ•°ã®ä»•çµ„ã¿
const problems2=[
()=>({q:"0.1ã¯1ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ",a:"10",unit:"åˆ†ã®ä¸€"}),
()=>({q:"0.01ã¯1ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ",a:"100",unit:"åˆ†ã®ä¸€"}),
()=>({q:"0.001ã¯1ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ",a:"1000",unit:"åˆ†ã®ä¸€"}),
()=>({q:"0.1ã¯ä½•å€ã™ã‚‹ã¨1ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",a:"10",unit:"å€"}),
()=>({q:"0.01ã¯ä½•å€ã™ã‚‹ã¨1ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",a:"100",unit:"å€"}),
()=>({q:"0.001ã¯ä½•å€ã™ã‚‹ã¨1ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",a:"1000",unit:"å€"})
];
return problems2[rand(0,problems2.length-1)]();

case 3: // å°æ•°ã®ä½
const ones=rand(1,9);
const tenths=rand(0,9);
const hundredths=rand(0,9);
const thousandths=rand(0,9);
return {
q:`${ones}.${tenths}${hundredths}${thousandths}ã¯1ã‚’ä½•å€‹ã€0.1ã‚’ä½•å€‹ã€0.01ã‚’ä½•å€‹ã€0.001ã‚’ä½•å€‹é›†ã‚ãŸæ•°ã§ã—ã‚‡ã†ï¼Ÿ`,
a:`${ones},${tenths},${hundredths},${thousandths}`,
type:'position'
};

case 4: // å°æ•°ã®å¤§å°ï¼ˆæ¡æ•°ãŒç•°ãªã‚‹æ•°å€¤ã§å‡ºé¡Œï¼‰
const patterns=[
// 4.305ã¨4.32ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
()=>{
const base=rand(1,20);
const decimal1=rand(100,999);
const decimal2=rand(10,99);
const a1=parseFloat(`${base}.${decimal1}`);
const a2=parseFloat(`${base}.${decimal2}`);
return {a1,a2};
},
// 17.102ã¨17.08ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
()=>{
const base=rand(10,25);
const decimal1=rand(100,199);
const decimal2=rand(1,9);
const a1=parseFloat(`${base}.${decimal1}`);
const a2=parseFloat(`${base}.0${decimal2}`);
return {a1,a2};
},
// 5.4ã¨5.387ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
()=>{
const base=rand(1,15);
const decimal1=rand(1,9);
const decimal2=rand(100,999);
const a1=parseFloat(`${base}.${decimal1}`);
const a2=parseFloat(`${base}.${decimal2}`);
return {a1,a2};
},
// 8.25ã¨8.247ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
()=>{
const base=rand(1,20);
const decimal1=rand(10,99);
const decimal2=rand(100,999);
const a1=parseFloat(`${base}.${decimal1}`);
const a2=parseFloat(`${base}.${decimal2}`);
return {a1,a2};
}
];

const pattern=patterns[rand(0,patterns.length-1)]();
let {a1,a2}=pattern;

// åŒã˜å€¤ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
while(a1===a2){
const newPattern=patterns[rand(0,patterns.length-1)]();
a1=newPattern.a1;
a2=newPattern.a2;
}

const isLeftSmaller=a1<a2;
const question=rand(0,1)?"å°ã•ã„ã»ã†":"å¤§ãã„ã»ã†";
let correctSide;
if(question==="å°ã•ã„ã»ã†"){
correctSide=isLeftSmaller?"left":"right";
}else{
correctSide=isLeftSmaller?"right":"left";
}

return {
q:`${a1}ã¨${a2}ã§${question}ã‚’é¸ã³ã¾ã—ã‚‡ã†`,
a:correctSide,
type:'choice'
};

case 5: // å°æ•° ä½•å€ã‹ï¼ˆä¿®æ­£ç‰ˆï¼‰
const multipliers = [10, 100, 1000];
const multiplier = multipliers[rand(0, multipliers.length-1)];
let base5;
if(multiplier === 10) {
base5 = rand(1, 99) / 100; // 0.01ã€œ0.99
} else if(multiplier === 100) {
base5 = rand(1, 99) / 1000; // 0.001ã€œ0.099
} else { // multiplier === 1000
base5 = rand(1, 99) / 10000; // 0.0001ã€œ0.0099
}
const result = base5 * multiplier;
return {
q: `${base5.toFixed(4).replace(/\.?0+$/, '')}ã‚’ä½•å€ã™ã‚‹ã¨${result.toFixed(3).replace(/\.?0+$/, '')}ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
a: multiplier.toString()
};

case 6: // å°æ•° ä½•åˆ†ã®ä¸€ã‹ï¼ˆä¿®æ­£ç‰ˆï¼‰
const divisors = [10, 100, 1000];
const divisor = divisors[rand(0, divisors.length-1)];
let base6;
if(divisor === 10) {
base6 = rand(10, 99) / 10; // 1.0ã€œ9.9
} else if(divisor === 100) {
base6 = rand(100, 999) / 10; // 10.0ã€œ99.9
} else { // divisor === 1000
base6 = rand(1000, 9999) / 10; // 100.0ã€œ999.9
}
const result6 = base6 / divisor;
return {
q: `${result6.toFixed(4).replace(/\.?0+$/, '')}ã¯${base6.toFixed(1)}ã®ä½•åˆ†ã®ä¸€ã§ã™ã‹ï¼Ÿ`,
a: divisor.toString(),
unit: "åˆ†ã®ä¸€"
};

case 7: // å°æ•°ã®æ§‹æˆ
const unitType=rand(0,2);
let unit, unitText, count, decimal;

if(unitType===0){
unit=0.1;
unitText="0.1";
count=rand(10,999);
decimal=count*0.1;
}else if(unitType===1){
unit=0.01;
unitText="0.01";
count=rand(100,999);
decimal=count*0.01;
}else{
unit=0.001;
unitText="0.001";
count=rand(100,999);
decimal=count*0.001;
}

return {
q:`${decimal.toFixed(3).replace(/\.?0+$/,'')}ã¯${unitText}ã‚’ã„ãã¤ ã‚ã¤ã‚ãŸ ã‹ãšã§ã—ã‚‡ã†ï¼Ÿ`,
a:count.toString(),
unit:"ã“"
};

case 8: // å°æ•°ã®è¶³ã—ç®—
const add1=rand(100,999)/100;
const add2=rand(100,999)/100;
return {
q:`${add1} + ${add2} =`,
a:(add1+add2).toFixed(3).replace(/\.?0+$/,'')
};

case 9: // å°æ•°ã®ã²ãç®—
const sub1=rand(500,999)/100;
const sub2=rand(100,400)/100;
return {
q:`${sub1} - ${sub2} =`,
a:(sub1-sub2).toFixed(3).replace(/\.?0+$/,'')
};

case 10: // å°æ•°æ–‡ç« å•é¡Œ
const problems10=[
()=>{
const ribbon1=rand(15,35)/10;
const ribbon2=rand(10,25)/10;
const operation=rand(0,1);
if(operation===0){
return {
q:`èµ¤ã„ãƒªãƒœãƒ³ã®é•·ã•ã¯${ribbon1}mã€é’ã„ãƒªãƒœãƒ³ã®é•·ã•ã¯${ribbon2}mã§ã™ã€‚2æœ¬ã®ãƒªãƒœãƒ³ã‚’ã¤ãªã’ã‚‹ã¨å…¨éƒ¨ã§ä½•mã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
a:(ribbon1+ribbon2).toFixed(1).replace(/\.?0+$/,''),
unit:"m"
};
}else{
const longer=Math.max(ribbon1,ribbon2);
const shorter=Math.min(ribbon1,ribbon2);
return {
q:`é•·ã„ãƒªãƒœãƒ³ã¯${longer}mã€çŸ­ã„ãƒªãƒœãƒ³ã¯${shorter}mã§ã™ã€‚é•·ã„ãƒªãƒœãƒ³ã¯çŸ­ã„ãƒªãƒœãƒ³ã‚ˆã‚Šä½•mé•·ã„ã§ã™ã‹ï¼Ÿ`,
a:(longer-shorter).toFixed(1).replace(/\.?0+$/,''),
unit:"m"
};
}
},
()=>{
const weight1=rand(15,45)/10;
const weight2=rand(8,25)/10;
const operation=rand(0,1);
if(operation===0){
return {
q:`ã‚Šã‚“ã”ã®é‡ã•ã¯${weight1}kgã€ã¿ã‹ã‚“ã®é‡ã•ã¯${weight2}kgã§ã™ã€‚ã‚Šã‚“ã”ã¨ã¿ã‹ã‚“ã‚’åˆã‚ã›ã‚‹ã¨ä½•kgã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
a:(weight1+weight2).toFixed(1).replace(/\.?0+$/,''),
unit:"kg"
};
}else{
const heavier=Math.max(weight1,weight2);
const lighter=Math.min(weight1,weight2);
return {
q:`é‡ã„è·ç‰©ã¯${heavier}kgã€è»½ã„è·ç‰©ã¯${lighter}kgã§ã™ã€‚é‡ã„è·ç‰©ã¯è»½ã„è·ç‰©ã‚ˆã‚Šä½•kgé‡ã„ã§ã™ã‹ï¼Ÿ`,
a:(heavier-lighter).toFixed(1).replace(/\.?0+$/,''),
unit:"kg"
};
}
},
()=>{
const liquid1=rand(12,38)/10;
const liquid2=rand(8,22)/10;
const operation=rand(0,1);
if(operation===0){
return {
q:`å¤§ãã„ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã«ã¯${liquid1}Lã€å°ã•ã„ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã«ã¯${liquid2}Lã®æ°´ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚2æœ¬åˆã‚ã›ã‚‹ã¨ä½•Lã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,
a:(liquid1+liquid2).toFixed(1).replace(/\.?0+$/,''),
unit:"L"
};
}else{
const more=Math.max(liquid1,liquid2);
const less=Math.min(liquid1,liquid2);
return {
q:`å®¹å™¨Aã«ã¯${more}Lã€å®¹å™¨Bã«ã¯${less}Lã®æ°´ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚å®¹å™¨Aã®æ–¹ãŒä½•Lå¤šã„ã§ã™ã‹ï¼Ÿ`,
a:(more-less).toFixed(1).replace(/\.?0+$/,''),
unit:"L"
};
}
},
()=>{
const time1=rand(12,35)/10;
const time2=rand(8,25)/10;
return {
q:`å®¿é¡Œã‚’ã™ã‚‹ã®ã«${time1}æ™‚é–“ã€èª­æ›¸ã‚’ã™ã‚‹ã®ã«${time2}æ™‚é–“ã‹ã‹ã‚Šã¾ã—ãŸã€‚å…¨éƒ¨ã§ä½•æ™‚é–“å‹‰å¼·ã—ã¾ã—ãŸã‹ï¼Ÿ`,
a:(time1+time2).toFixed(1).replace(/\.?0+$/,''),
unit:"æ™‚é–“"
};
},
()=>{
const dist1=rand(15,45)/10;
const dist2=rand(8,28)/10;
const operation=rand(0,1);
if(operation===0){
return {
q:`å­¦æ ¡ã¾ã§${dist1}kmã€å›³æ›¸é¤¨ã¾ã§${dist2}kmæ­©ãã¾ã—ãŸã€‚å…¨éƒ¨ã§ä½•kmæ­©ã„ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ`,
a:(dist1+dist2).toFixed(1).replace(/\.?0+$/,''),
unit:"km"
};
}else{
const longer=Math.max(dist1,dist2);
const shorter=Math.min(dist1,dist2);
return {
q:`é ã„é“ã®ã‚Šã¯${longer}kmã€è¿‘ã„é“ã®ã‚Šã¯${shorter}kmã§ã™ã€‚é ã„é“ã®ã‚Šã¯è¿‘ã„é“ã®ã‚Šã‚ˆã‚Šä½•kmé•·ã„ã§ã™ã‹ï¼Ÿ`,
a:(longer-shorter).toFixed(1).replace(/\.?0+$/,''),
unit:"km"
};
}
}
];
return problems10[rand(0,problems10.length-1)]();

case 11: // å°æ•°ã®è‰²ã€…ãªè¦‹æ–¹
const problems11=[
// 3.71ã¯3ã¨ä½•ã‚’åˆã‚ã›ãŸæ•°ã§ã™ã‹ï¼Ÿ
()=>{
const whole=rand(2,8);
const decimal=rand(10,99)/100;
const combined=whole+decimal;
return {
q:`${combined.toFixed(2)}ã¯${whole}ã¨ä½•ã‚’åˆã‚ã›ãŸæ•°ã§ã™ã‹ï¼Ÿ`,
a:decimal.toFixed(2).replace(/\.?0+$/,'')
};
},
// 3.45ã¯3.5ã‚ˆã‚Šã©ã‚Œã ã‘å°ã•ã„æ•°ã§ã™ã‹ï¼Ÿ
()=>{
const base=rand(20,89)/10;
const diff=rand(1,9)/100;
const smaller=base-diff;
return {
q:`${smaller.toFixed(2)}ã¯${base.toFixed(1)}ã‚ˆã‚Šã©ã‚Œã ã‘å°ã•ã„æ•°ã§ã™ã‹ï¼Ÿ`,
a:diff.toFixed(2).replace(/\.?0+$/,'')
};
},
// 4.75ã¯1ã‚’â–¡ã“ã€0.1ã‚’â–¡ã“ã€0.01ã‚’â–¡ã“é›†ã‚ãŸæ•°ã§ã™
()=>{
const ones=rand(1,9);
const tenths=rand(0,9);
const hundredths=rand(1,9);
return {
q:`${ones}.${tenths}${hundredths}ã¯1ã‚’â–¡ã“ã€0.1ã‚’â–¡ã“ã€0.01ã‚’â–¡ã“é›†ã‚ãŸæ•°ã§ã™`,
a:`${ones},${tenths},${hundredths}`,
type:'multi'
};
},
// 6.2ã¯0.01ã‚’ã„ãã¤é›†ã‚ãŸæ•°ã§ã™ã‹ï¼Ÿ
()=>{
const decimal=rand(10,99)/10;
const count=decimal*100;
return {
q:`${decimal.toFixed(1)}ã¯0.01ã‚’ã„ãã¤é›†ã‚ãŸæ•°ã§ã™ã‹ï¼Ÿ`,
a:count.toString(),
unit:"ã“"
};
}
];
return problems11[rand(0,problems11.length-1)]();
}
}

// ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®é–¢æ•°
function startTimer(){
startTime=Date.now();
timerInterval=setInterval(updateTimer,100);
}

function updateTimer(){
const elapsed=Date.now()-startTime;
const minutes=Math.floor(elapsed/60000);
const seconds=Math.floor((elapsed%60000)/1000);
const milliseconds=Math.floor((elapsed%1000)/10);
$("timerText").textContent=`${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}.${milliseconds.toString().padStart(2,'0')}`;
}

function stopTimer(){
if(timerInterval){
clearInterval(timerInterval);
timerInterval=null;
}
}

function getElapsedTime(){
if(startTime){
const elapsed=Date.now()-startTime;
const minutes=Math.floor(elapsed/60000);
const seconds=Math.floor((elapsed%60000)/1000);
const milliseconds=Math.floor((elapsed%1000)/10);
return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}.${milliseconds.toString().padStart(2,'0')}`;
}
return "00:00.00";
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ã®é–¢æ•°
function saveRecord(time){
const records=JSON.parse(localStorage.getItem('mathQuestRecords')||'[]');
const newRecord={
time:time,
timestamp:Date.now(),
date:formatDateTime(Date.now())
};
records.push(newRecord);
records.sort((a,b)=>a.timestamp-b.timestamp);
localStorage.setItem('mathQuestRecords',JSON.stringify(records));
return records;
}

function displayRanking(currentTime){
const records=saveRecord(currentTime);
const myRecord=records[records.length-1];
const myRank=records.findIndex(r=>r.timestamp===myRecord.timestamp)+1;
const top3=records.slice(0,3);

$("myRankDisplay").innerHTML=`ã‚ãªãŸã®é †ä½: ${myRank}ä½ / ${records.length}äººä¸­<br>ã‚¿ã‚¤ãƒ : ${currentTime}<br><div class="record-time">è¨˜éŒ²æ—¥æ™‚: ${myRecord.date}</div>`;

let top3Html="";
top3.forEach((record,index)=>{
const medal=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][index];
top3Html+=`<div class="ranking-item">${medal} ${index+1}ä½: ${record.time}<div class="record-time">è¨˜éŒ²æ—¥æ™‚: ${record.date}</div></div>`;
});
$("top3Display").innerHTML=top3Html;
$("ranking").style.display="block";
}

// ç”»é¢é·ç§»é–¢æ•°
function showLevelSelect(){
$("start").style.display="none";
$("levelSelect").style.display="block";
}

function goBackToStart(){
// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
stopAllAnimations();

$("levelSelect").style.display="none";
$("game").style.display="none";
$("gameover").style.display="none";
$("clear").style.display="none";
$("start").style.display="block";
}

function startSelect(selectedLevel){
gameMode="select";
level=selectedLevel;
startGame();
}

function startPractice(){
gameMode="practice";
startGame();
}

function startSummary(){
gameMode="summary";
startGame();
}

function startGame(){
$("start").style.display="none";
$("levelSelect").style.display="none";
$("game").style.display="block";
score=0;
if(gameMode!=="select"){
level=1;
}
hp=1;streak=0;summaryLevelCount=0;selectCorrectCount=0;

if(gameMode==="summary"){
$("timerDisplay").style.display="block";
startTimer();
}else{
$("timerDisplay").style.display="none";
}

updateDisplay();
nextQ();
}

function updateDisplay(){
$("lv").textContent=level;
$("lvInfo").textContent=levelNames[level-1];
$("score").textContent=score;
$("monster").textContent=monsters[level-1];

if(gameMode==="select"){
$("modeDisplay").textContent="ğŸ¯ é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰";
$("practiceProgress").style.display="none";
$("summaryProgress").style.display="none";
$("selectProgress").style.display="block";
$("hpDisplay").style.display="none";
$("selectCount").textContent=selectCorrectCount;
const selectProgress=(selectCorrectCount/10)*100;
$("selectProgressBar").style.width=selectProgress+"%";
}else if(gameMode==="practice"){
$("modeDisplay").textContent="ğŸ“ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰";
$("practiceProgress").style.display="block";
$("summaryProgress").style.display="none";
$("selectProgress").style.display="none";
$("hpDisplay").style.display="none";
$("streakCount").textContent=streak;
const progress=(streak/5)*100;
$("progressBar").style.width=progress+"%";
}else{
$("modeDisplay").textContent="ğŸ† ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰";
$("practiceProgress").style.display="none";
$("summaryProgress").style.display="block";
$("selectProgress").style.display="none";
$("hpDisplay").style.display="inline";
$("hp").textContent=hp;
$("summaryCount").textContent=summaryLevelCount;
const summaryProgress=(summaryLevelCount/5)*100;
$("summaryProgressBar").style.width=summaryProgress+"%";
}
}

function nextQ(){
// ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
if(gameMode==="practice" && streak>=5){
if(level>=11){showClear();return}
level++;
streak=0;
$("monster").classList.add("level-up");
createLevelUpExplosion();
setTimeout(()=>$("monster").classList.remove("level-up"),2000);
}
// ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
else if(gameMode==="summary" && summaryLevelCount>=5){
if(level>=11){showClear();return}
level++;
summaryLevelCount=0;
$("monster").classList.add("level-up");
createLevelUpExplosion();
setTimeout(()=>$("monster").classList.remove("level-up"),2000);
}
// é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ãƒªã‚¢ãƒã‚§ãƒƒã‚¯
else if(gameMode==="select" && selectCorrectCount>=10){
showClear();
return;
}

currentProblem=generateProblem(level);
$("q").textContent=currentProblem.q;
ans=currentProblem.a;
currentUnit=currentProblem.unit||"";
selectedChoice="";

// å…¥åŠ›æ–¹æ³•ã®è¨­å®š
if(level===3){
// å°æ•°ã®ä½ã®å•é¡Œ
$("normalInput").style.display="none";
$("positionInputs").style.display="flex";
$("multiInputs").style.display="none";
$("choiceButtons").style.display="none";
$("submitButton").style.display="inline-block";
$("ones").value="";
$("tenths").value="";
$("hundredths").value="";
$("thousandths").value="";
$("ones").focus();
}else if(currentProblem.type==='choice'){
// é¸æŠå•é¡Œ
$("normalInput").style.display="none";
$("positionInputs").style.display="none";
$("multiInputs").style.display="none";
$("choiceButtons").style.display="block";
$("submitButton").style.display="none";
}else if(currentProblem.type==='multi'){
// è¤‡æ•°å…¥åŠ›å•é¡Œ
$("normalInput").style.display="none";
$("positionInputs").style.display="none";
$("multiInputs").style.display="flex";
$("choiceButtons").style.display="none";
$("submitButton").style.display="inline-block";
$("multi1").value="";
$("multi2").value="";
$("multi3").value="";
$("multi1").focus();
}else{
// é€šå¸¸ã®å…¥åŠ›
$("normalInput").style.display="block";
$("positionInputs").style.display="none";
$("multiInputs").style.display="none";
$("choiceButtons").style.display="none";
$("submitButton").style.display="inline-block";
$("input").value="";
$("input").focus();
}

// å˜ä½è¡¨ç¤ºã®è¨­å®š
if(currentUnit){
$("unitDisplay").textContent=currentUnit;
$("unitDisplay").style.display="inline-block";
}else{
$("unitDisplay").style.display="none";
}

$("answer").style.display="block";
$("result").style.display="none";
updateDisplay();
}

function submit(){
let userAns;
if(level===3){
const ones=$("ones").value||"0";
const tenths=$("tenths").value||"0";
const hundredths=$("hundredths").value||"0";
const thousandths=$("thousandths").value||"0";
userAns=`${ones},${tenths},${hundredths},${thousandths}`;
}else if(currentProblem.type==='choice'){
userAns=selectedChoice;
}else if(currentProblem.type==='multi'){
const multi1=$("multi1").value||"0";
const multi2=$("multi2").value||"0";
const multi3=$("multi3").value||"0";
userAns=`${multi1},${multi2},${multi3}`;
}else{
userAns=$("input").value.trim();
}

$("answer").style.display="none";
$("result").style.display="block";

if(userAns===ans){
// æ­£è§£
score++;
if(gameMode==="practice"){
streak++;
}else if(gameMode==="summary"){
summaryLevelCount++;
}else if(gameMode==="select"){
selectCorrectCount++;
}
$("monster").classList.add("correct");
createSparkles();
setTimeout(()=>$("monster").classList.remove("correct"),1000);
$("correctResult").style.display="block";
$("wrongResult").style.display="none";
}else{
// ä¸æ­£è§£
if(gameMode==="practice"){
streak=0;
}else if(gameMode==="summary"){
hp--;
}
$("monster").classList.add("wrong");
setTimeout(()=>$("monster").classList.remove("wrong"),1000);
$("correctResult").style.display="none";
$("wrongResult").style.display="block";
displayCorrectAnswer();

if(gameMode==="summary"){
setTimeout(showGameOver,1500);
return;
}
}
updateDisplay();
}

function displayCorrectAnswer(){
let displayAnswer;
if(level===3){
const parts=ans.split(',');
displayAnswer=`1ã®ä½ï¼š${parts[0]}ã€0.1ã®ä½ï¼š${parts[1]}ã€0.01ã®ä½ï¼š${parts[2]}ã€0.001ã®ä½ï¼š${parts[3]}`;
}else if(currentProblem.type==='choice'){
displayAnswer=ans==='left'?'å·¦':'å³';
}else if(currentProblem.type==='multi'){
const parts=ans.split(',');
displayAnswer=`1ã‚’${parts[0]}ã“ã€0.1ã‚’${parts[1]}ã“ã€0.01ã‚’${parts[2]}ã“`;
}else{
displayAnswer=ans+(currentUnit?currentUnit:"");
}
$("correctAnswerText").textContent=displayAnswer;
}

function showGameOver(){
stopTimer();
$("game").style.display="none";
$("gameover").style.display="block";
$("finalLevel").textContent=level;
$("finalScore1").textContent=score;
if(gameMode==="summary"){
$("gameoverMsg").textContent="æ®‹å¿µï¼é–“é•ãˆã¦ã—ã¾ã„ã¾ã—ãŸ";
const finalTime=getElapsedTime();
$("finalTime1").textContent=finalTime;
$("gameoverTime").style.display="block";
}
}

function showClear(){
stopTimer();
$("game").style.display="none";
$("clear").style.display="block";
$("finalScore2").textContent=score;
document.body.classList.add("clear-screen");

// é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´
if(gameMode==="select"){
$("clearMessage").textContent=`${levelNames[level-1]}ã‚’ãƒã‚¹ã‚¿ãƒ¼ï¼`;
}else{
$("clearMessage").textContent="å…¨ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ï¼";
}

createClearCelebration();

if(gameMode==="summary"){
const finalTime=getElapsedTime();
$("finalTime2").textContent=finalTime;
$("clearTime").style.display="block";
displayRanking(finalTime);
}
}

function goHome(){
if(confirm("ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿé€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚")){
goBackToStart();
}
}

$("input").addEventListener("keypress",e=>{if(e.key==="Enter")submit()});
["ones","tenths","hundredths","thousandths","multi1","multi2","multi3"].forEach(id=>{
$(id).addEventListener("keypress",e=>{if(e.key==="Enter")submit()});
});
</script>
</body>
</html>
